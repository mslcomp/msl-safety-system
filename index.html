<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MSL ì•ˆì „ë³´ê±´ê´€ë¦¬ í”Œë«í¼ v2.0</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- Confetti -->
   <script>const norm = (s) => (s ?? "").toString().trim().replace(/\s+/g, " ");

function getToken() {
  const urlT = new URLSearchParams(location.search).get("t");
  const t = norm(urlT) || norm(localStorage.getItem("token"));
  if (t) localStorage.setItem("token", t);
  return t;
}

const token = getToken();
console.log("BOOT token=", token);
</script>
   
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg: #F6F8FC;
      --surface: rgba(255,255,255,.78);
      --surface-2: rgba(255,255,255,.92);
      --stroke: rgba(20, 30, 60, .08);
      --stroke-strong: rgba(20, 30, 60, .12);
      --text: #101828;
      --muted: rgba(16,24,40,.58);

      --primary: #2B6BFF;
      --primary-2:#4ED0FF;
      --accent: #FFB800;
      --danger: #FF3B5C;
      --success:#12B76A;

      --shadow: 0 14px 40px rgba(16,24,40,.10);
      --shadow-soft: 0 10px 30px rgba(16,24,40,.08);
      --radius-xl: 26px;
      --radius-lg: 20px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --blur: blur(14px);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --ring-bg: rgba(43,107,255,.10);
      --ring-fg: var(--primary);

      --card-gap: 14px;
    }

    [data-theme="dark"]{
      --bg: #0B1020;
      --surface: rgba(18, 28, 55, .55);
      --surface-2: rgba(18, 28, 55, .72);
      --stroke: rgba(255,255,255,.10);
      --stroke-strong: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.55);
      --shadow: 0 18px 46px rgba(0,0,0,.40);
      --shadow-soft: 0 12px 38px rgba(0,0,0,.35);
      --ring-bg: rgba(78, 208, 255, .10);
      --ring-fg: #4ED0FF;
    }

    *{ box-sizing: border-box; margin:0; padding:0; }
    html, body{ height: 100%; }
    body{
      font-family: "Noto Sans KR", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(78,208,255,.35), transparent 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(43,107,255,.28), transparent 52%),
        radial-gradient(900px 700px at 40% 120%, rgba(255,184,0,.18), transparent 55%),
        var(--bg);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
    }

    [data-theme="dark"] body{
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(43,107,255,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 0%, rgba(78,208,255,.20), transparent 55%),
        radial-gradient(900px 700px at 40% 120%, rgba(255,184,0,.12), transparent 60%),
        var(--bg);
    }

    .app{
      max-width: 460px;
      margin: 0 auto;
      min-height: 100%;
      padding-bottom: calc(84px + var(--safe-bottom));
    }

    .top{
      position: sticky;
      top: 0;
      z-index: 100;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      backdrop-filter: var(--blur);
      background: linear-gradient(to bottom, rgba(246,248,252,.82), rgba(246,248,252,.52));
      border-bottom: 1px solid var(--stroke);
    }
    [data-theme="dark"] .top{
      background: linear-gradient(to bottom, rgba(11,16,32,.86), rgba(11,16,32,.52));
    }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .logo{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: linear-gradient(135deg, #2B6BFF, #4ED0FF);
      box-shadow: 0 10px 22px rgba(43,107,255,.25);
      display:grid;
      place-items:center;
      color:white;
      font-weight:800;
      font-size:14px;
      letter-spacing:-.5px;
      user-select:none;
      flex-shrink:0;
    }

    .brand-title{
      line-height:1.1;
      min-width:0;
    }
    .brand-title b{
      display:block;
      font-size: 14px;
      letter-spacing: -.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:800;
    }
    .brand-title span{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
      font-weight:500;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .icon-btn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow-soft);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .15s ease;
      flex-shrink:0;
    }
    .icon-btn:active{ transform: scale(.98); }

    .icon{
      width: 18px; height:18px;
      opacity:.86;
    }

    .hero{
      margin-top: 12px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(43,107,255,.95), rgba(78,208,255,.90));
      box-shadow: var(--shadow);
      padding: 16px;
      color: white;
      position: relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-60px -80px auto auto;
      width: 240px; height: 240px;
      border-radius: 60px;
      background: rgba(255,255,255,.14);
      transform: rotate(18deg);
    }
    .hero:after{
      content:"";
      position:absolute;
      inset:auto auto -110px -110px;
      width: 280px; height: 280px;
      border-radius: 90px;
      background: rgba(0,0,0,.10);
      transform: rotate(-12deg);
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      z-index:1;
    }

    .hero h1{
      margin: 0;
      font-size: 16px;
      letter-spacing: -.3px;
      font-weight:800;
    }

    .hero p{
      margin: 6px 0 0;
      font-size: 12px;
      opacity: .90;
      font-weight:500;
    }

    .pill-row{
      display:flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      font-size: 12px;
      font-weight: 600;
      white-space:nowrap;
    }

    .dot{
      width:8px; height:8px;
      border-radius: 99px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 0 0 4px rgba(255,255,255,.12);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.16);
      white-space:nowrap;
      letter-spacing:-.1px;
    }

    .tabs{
      margin-top: 12px;
      background: var(--surface);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px;
      display:flex;
      gap:6px;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow-soft);
      position:relative;
      z-index:1;
    }

    .tab{
      flex:1;
      padding: 10px 8px;
      border-radius: 999px;
      border: 0;
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: all .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }

    .tab.active{
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--stroke-strong);
    }

    .badge{
      min-width: 18px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      background: rgba(16,24,40,.10);
      color: rgba(16,24,40,.75);
    }

    [data-theme="dark"] .badge{
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.80);
    }

    .content{
      padding: 16px;
    }

    .section-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      margin: 8px 2px 10px;
    }

    .section-title h2{
      margin:0;
      font-size: 14px;
      letter-spacing: -.25px;
      font-weight:800;
    }

    .section-title span{
      font-size: 12px;
      color: var(--muted);
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--card-gap);
    }

    .card{
      border-radius: var(--radius-xl);
      border: 1px solid var(--stroke);
      background: var(--surface);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      position:relative;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .card:active{
      transform: scale(.99);
    }

    .card-head{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--stroke);
    }

    .card-head .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
      flex:1;
    }

    .card-head .title{
      min-width:0;
      flex:1;
    }

    .card-head .title b{
      display:block;
      font-size: 13px;
      letter-spacing: -.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:800;
    }

    .card-head .title span{
      display:block;
      margin-top:3px;
      font-size: 12px;
      color: var(--muted);
      font-weight:600;
    }

    .status-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid var(--stroke);
      background: var(--surface-2);
      white-space:nowrap;
      flex-shrink:0;
    }

    .status-chip.red{
      color: var(--danger);
      background: rgba(255,59,92,.08);
      border-color: rgba(255,59,92,.15);
    }

    .status-chip.blue{
      color: var(--primary);
      background: rgba(43,107,255,.08);
      border-color: rgba(43,107,255,.15);
    }

    .status-chip.orange{
      color: var(--accent);
      background: rgba(255,184,0,.08);
      border-color: rgba(255,184,0,.15);
    }

    .status-chip.green{
      color: var(--success);
      background: rgba(18,183,106,.08);
      border-color: rgba(18,183,106,.15);
    }

    .emoji{
      width: 40px; height: 40px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      border: 1px solid var(--stroke);
      background: var(--surface-2);
      font-size: 18px;
      box-shadow: 0 10px 20px rgba(16,24,40,.06);
      user-select:none;
      flex-shrink:0;
    }

    .card-body{
      padding: 14px;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .stat{
      border-radius: var(--radius-lg);
      border: 1px solid var(--stroke);
      background: var(--surface-2);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }

    .stat:before{
      content:"";
      position:absolute;
      inset:-30px -30px auto auto;
      width: 110px; height: 110px;
      border-radius: 40px;
      background: rgba(43,107,255,.10);
      transform: rotate(12deg);
    }

    .stat.orange:before{ background: rgba(255,184,0,.12); }
    .stat.green:before{ background: rgba(18,183,106,.10); }
    .stat.red:before{ background: rgba(255,59,92,.08); }

    .stat b{
      display:block;
      font-size: 12px;
      color: var(--muted);
      position:relative;
      z-index:1;
      font-weight:800;
    }

    .stat .value{
      display:flex;
      align-items:baseline;
      gap:6px;
      position:relative;
      z-index:1;
      margin-top: 8px;
    }

    .stat .value strong{
      font-size: 20px;
      letter-spacing: -.4px;
      font-weight:900;
    }

    .stat .value span{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .cta{
      margin-top: 10px;
      display:flex;
      gap: 10px;
    }

    .btn{
      flex:1;
      border: 0;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing: -.2px;
      font-size: 13px;
      transition: transform .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select:none;
    }

    .btn:active{ transform: scale(.99); }

    .btn.primary{
      color:white;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 14px 26px rgba(43,107,255,.25);
    }

    .btn.ghost{
      background: var(--surface-2);
      border: 1px solid var(--stroke);
      color: var(--text);
    }

    .file-upload-btn{
      width: 100%;
      padding: 16px;
      border-radius: var(--radius-lg);
      border: 2px dashed var(--stroke);
      background: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all .2s ease;
      font-family: inherit;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }
    .file-upload-btn:hover{
      border-color: var(--primary);
      background: rgba(43,107,255,.06);
      transform: translateY(-2px);
    }
    .file-upload-btn:active{ transform: translateY(0); }

    .bottom-bar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(460px, 100%);
      padding: 10px 14px calc(10px + var(--safe-bottom));
      z-index: 200;
      pointer-events:none;
    }
    .bottom-inner{
      pointer-events:auto;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      display:flex;
      gap: 8px;
      padding: 8px;
    }
    .navbtn{
      flex: 1;
      border: 0;
      background: transparent;
      color: var(--muted);
      border-radius: 16px;
      padding: 10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      cursor:pointer;
      font-size: 11px;
      font-weight: 800;
      transition: all .15s ease;
    }
    .navbtn svg{
      width: 18px;
      height:18px;
      opacity:.85;
      transition: opacity .15s ease;
    }
    .navbtn.active{
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--stroke-strong);
    }
    .navbtn.active svg{ opacity:1; }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 300;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }

    .sheet{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: -100%;
      width: min(460px, 100%);
      background: var(--surface-2);
      border: 1px solid var(--stroke);
      border-bottom: 0;
      border-radius: 24px 24px 0 0;
      box-shadow: var(--shadow);
      transition: bottom .25s cubic-bezier(.2,.9,.2,1);
      z-index: 400;
      padding-bottom: calc(12px + var(--safe-bottom));
      overflow:hidden;
      max-height: 85vh;
      display:flex;
      flex-direction:column;
    }
    .sheet.show{ bottom: 0; }

    .sheet-head{
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,.75), transparent);
      flex-shrink:0;
    }
    [data-theme="dark"] .sheet-head{
      background: linear-gradient(to bottom, rgba(18,28,55,.70), transparent);
    }

    .grab{
      width: 54px; height: 5px;
      border-radius: 999px;
      background: rgba(16,24,40,.14);
      margin: 8px auto 0;
    }
    [data-theme="dark"] .grab{ background: rgba(255,255,255,.16); }

    .sheet-head b{
      font-size: 13px;
      letter-spacing: -.2px;
      font-weight:800;
    }

    .sheet-body{
      padding: 14px;
      overflow-y: auto;
      flex:1;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .label{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .input, .textarea, .select{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.60);
      padding: 12px 12px;
      font-size: 13px;
      outline:none;
      color: var(--text);
      font-family: inherit;
      font-weight:600;
      transition: border-color .2s ease;
    }
    .input:focus, .textarea:focus, .select:focus{ border-color: var(--primary); }
    [data-theme="dark"] .input,
    [data-theme="dark"] .textarea,
    [data-theme="dark"] .select{ background: rgba(11,16,32,.35); }

    .textarea{
      min-height: 92px;
      resize:vertical;
      line-height:1.5;
    }

    .sheet-actions{
      padding: 0 14px;
      display:flex;
      gap:10px;
      flex-shrink:0;
    }

    .fade-in{ animation: fadeIn .18s ease both; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .hide{ display:none !important; }
    .loading{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
    }

    .empty{
      border-radius: var(--radius-lg);
      border: 1px dashed var(--stroke-strong);
      background: rgba(255,255,255,.35);
      padding: 18px 14px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    [data-theme="dark"] .empty{ background: rgba(18,28,55,.32); }

    .empty .mail{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: rgba(43,107,255,.12);
      border: 1px solid rgba(43,107,255,.20);
      font-size: 20px;
      flex: 0 0 auto;
    }

    .empty b{
      display:block;
      font-size: 13px;
      letter-spacing: -.2px;
      font-weight:800;
    }
    .empty span{
      display:block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      font-weight:600;
      line-height:1.4;
    }

    .modal{
      position:fixed;
      inset:0;
      z-index:500;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.45);
      backdrop-filter:blur(4px);
      padding:16px;
    }
    .modal.show{ display:flex; }

    .modal-content{
      background: var(--surface-2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      width:100%;
      max-width:500px;
      max-height:85vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-shrink:0;
    }
    .modal-header h3{
      font-size:14px;
      font-weight:800;
      letter-spacing:-.25px;
    }
    .modal-body{
      padding:12px;
      overflow-y:auto;
      overflow-x:hidden;
      flex:1;
      -webkit-overflow-scrolling: touch;
    }

    .tbm-section{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--stroke);
      background: var(--surface);
    }
    .tbm-title{
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--text);
    }
    .tbm-item{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 10px;
      background: rgba(255,255,255,.50);
      border: 1px solid var(--stroke);
      transition: all .2s ease;
    }
    .tbm-item:last-child{ margin-bottom: 0; }
    [data-theme="dark"] .tbm-item{ background: rgba(11,16,32,.25); }
    .tbm-item:hover{
      background: rgba(255,255,255,.80);
      border-color: var(--primary);
    }
    [data-theme="dark"] .tbm-item:hover{ background: rgba(11,16,32,.45); }

    .tbm-checkbox{
      width: 20px;
      height: 20px;
      border: 2px solid var(--stroke-strong);
      border-radius: 6px;
      cursor: pointer;
      transition: all .2s ease;
      flex-shrink: 0;
      appearance: none;
      -webkit-appearance: none;
      position: relative;
      background: transparent;
    }
    .tbm-checkbox:checked{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border-color: var(--primary);
    }
    .tbm-checkbox:checked::before{
      content: 'âœ“';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 13px;
      font-weight: 900;
      line-height: 1;
    }

    .tbm-label{
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      user-select: none;
      line-height: 1.4;
    }

    .nearmiss-list{
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .nearmiss-item{
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      transition: all .2s ease;
    }
    .nearmiss-item:hover{
      border-color: rgba(43,107,255,.25);
      box-shadow: 0 4px 12px rgba(43,107,255,.08);
    }
    .status-option:hover{
      border-color: var(--primary) !important;
      background: rgba(43,107,255,.06) !important;
      transform: translateX(4px);
    }

    .calendar-container{
      margin-top: 16px;
      padding: 16px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--stroke);
      background: var(--surface);
    }
    .calendar-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .calendar-title{
      font-size: 14px;
      font-weight: 900;
      color: var(--text);
      letter-spacing: -.3px;
    }
    .calendar-nav{
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: var(--surface-2);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all .2s ease;
    }
    .calendar-nav:hover{
      background: rgba(43,107,255,.08);
      border-color: rgba(43,107,255,.2);
    }
    .calendar-nav:active{ transform: scale(.95); }

    .calendar-weekdays{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .calendar-weekday{
      text-align: center;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
      padding: 6px 0;
    }
    .calendar-days{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day{
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      position: relative;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      transition: all .2s ease;
    }
    .calendar-day.empty{ visibility: hidden; }
    .calendar-day.today{
      background: rgba(43,107,255,.12);
      border: 2px solid var(--primary);
      color: var(--primary);
      font-weight: 900;
    }
    .calendar-day.has-document{
      background: linear-gradient(135deg, rgba(43,107,255,.15), rgba(78,208,255,.10));
      border: 1px solid rgba(43,107,255,.25);
      font-weight: 900;
    }
    .calendar-day.has-document:not(.today):hover{
      background: linear-gradient(135deg, rgba(43,107,255,.25), rgba(78,208,255,.18));
      transform: scale(1.05);
      cursor: pointer;
    }
    .calendar-day.selected{
      background: linear-gradient(135deg, rgba(255,184,0,.20), rgba(255,152,0,.15)) !important;
      border: 2px solid var(--accent) !important;
      font-weight: 900;
      box-shadow: 0 0 0 3px rgba(255,184,0,.15);
    }
    .calendar-dot{
      position: absolute;
      bottom: 3px;
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--primary);
      box-shadow: 0 0 0 2px rgba(43,107,255,.15);
    }
    .calendar-legend{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--stroke);
    }
    .legend-item{
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--primary);
      box-shadow: 0 0 0 3px rgba(43,107,255,.15);
    }
    .legend-item span{
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }

    .btn-nearmiss{
      margin-top: 12px;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(255,184,0,.06), rgba(255,152,0,.04));
      cursor: pointer;
      transition: all .2s ease;
      font-family: inherit;
    }
    .btn-nearmiss:hover{
      background: linear-gradient(135deg, rgba(255,184,0,.12), rgba(255,152,0,.08));
      border-color: rgba(255,184,0,.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255,184,0,.15);
    }
    .btn-nearmiss:active{ transform: translateY(0); }

    .btn-nearmiss-icon{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, #FFB800, #FF9800);
      display: grid;
      place-items: center;
      font-size: 22px;
      flex-shrink: 0;
      box-shadow: 0 6px 16px rgba(255,184,0,.25);
    }
    .btn-nearmiss-content{ flex: 1; text-align: left; min-width: 0; }
    .btn-nearmiss-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -.2px;
      margin-bottom: 3px;
    }
    .btn-nearmiss-desc{
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      line-height: 1.4;
    }

    .doc-menu{
      padding: 8px;
      background: var(--surface-2);
      border-top: 1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .menu-item{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border: 0;
      background: transparent;
      color: var(--text);
      font-size: 13px;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all .2s ease;
      font-family: inherit;
      text-align: left;
    }
    .menu-item:hover{
      background: rgba(43,107,255,.08);
      color: var(--primary);
    }
    .menu-item.danger{ color: var(--danger); }
    .menu-item.danger:hover{ background: rgba(255,59,92,.08); }

    .sig-status-modal{
      max-height: 60vh;
      overflow-y: auto;
    }
    .sig-list{
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }
    .sig-item{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--surface);
    }
    .sig-item .left{
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sig-item .avatar{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      display: grid;
      place-items: center;
      color: white;
      font-weight: 800;
      font-size: 14px;
    }
    .sig-item .info b{
      display: block;
      font-size: 13px;
      font-weight: 800;
    }
    .sig-item .info span{
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-weight: 600;
    }
    .sig-item .check{
      color: var(--success);
      font-size: 18px;
    }

    .doc-content{
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(43,107,255,.04), rgba(78,208,255,.02));
      margin-bottom: 12px;
    }
    .doc-content-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 8px;
    }
    .doc-content-text{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      font-weight: 600;
      white-space: pre-wrap;
    }


/* âœ… ë¬¸ì„œ ì•¡ì…˜ ë²„íŠ¼(í™•ì¸ë¥  ì•„ë˜ 5ê°œ ë²„íŠ¼) */
.doc-actions{
  margin-top: 10px;                 /* í™•ì¸ë¥  ë°”ë¡œ ì•„ë˜ ê°„ê²© */
  display: flex;
  gap: 8px;
  flex-wrap: wrap;                  /* ëª¨ë°”ì¼ì—ì„œ ìë™ ì¤„ë°”ê¿ˆ */
}

.doc-actions .actionBtn{
  height: 36px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-2);
  color: var(--text);
  font-weight: 900;
  font-size: 12px;
  letter-spacing: -.2px;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(16,24,40,.06);
  white-space: nowrap;

  /* âœ… í•œ ì¤„ì— ìµœëŒ€í•œ ê¹”ë”, ê³µê°„ ë¶€ì¡±í•˜ë©´ ë‹¤ìŒ ì¤„ë¡œ */
  flex: 1 1 auto;
  min-width: 118px;
}

.doc-actions .actionBtn:active{
  transform: scale(.98);
}

.doc-actions .actionBtn.danger{
  border-color: rgba(255,59,92,.20);
  background: rgba(255,59,92,.08);
  color: var(--danger);
}

/* âœ… ì°¨ëŸ‰ ì¹´ë“œì—ì„œëŠ” ë²„íŠ¼ í­ì„ ì¡°ê¸ˆ ë” ì»´íŒ©íŠ¸í•˜ê²Œ */
.vehicle-actions .actionBtn{
  min-width: 96px;
}


/* =========================
   Segmented (3ë¶„í• ) Buttons
========================= */
.segmented{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 12px;
  padding: 6px;
  border-radius: 18px;
  border: 1px solid var(--stroke);
  background: var(--surface-2);
  backdrop-filter: var(--blur);
}

.seg-btn{
  border: 0;
  cursor: pointer;
  border-radius: 14px;
  padding: 12px 10px;
  font-size: 12px;
  font-weight: 900;
  letter-spacing: -.2px;
  color: var(--text);
  background: transparent;
  transition: transform .15s ease, background .15s ease, border-color .15s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  user-select: none;
  border: 1px solid transparent;
}

.seg-btn:hover{
  background: rgba(43,107,255,.08);
  border-color: rgba(43,107,255,.18);
}

.seg-btn:active{
  transform: scale(.99);
}

.seg-btn.primary{
  color: white;
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  box-shadow: 0 10px 18px rgba(43,107,255,.18);
}

.seg-btn.danger{
  color: var(--danger);
  background: rgba(255,59,92,.08);
  border-color: rgba(255,59,92,.16);
}

.seg-btn.danger:hover{
  background: rgba(255,59,92,.12);
  border-color: rgba(255,59,92,.22);
}

.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:flex; align-items:flex-end; justify-content:center;
  z-index:9999; padding:12px;
}
.modal-sheet{
  width:min(520px, 100%); background:#fff; border-radius:18px;
  box-shadow:0 14px 40px rgba(0,0,0,.18);
  overflow:hidden;
}
.modal-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 14px; border-bottom:1px solid rgba(0,0,0,.06);
}
.modal-title{ font-weight:900; font-size:15px; }
.modal-body{ padding:14px; max-height:70vh; overflow:auto; }
.edu-item{
  padding:12px 12px; border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(43,107,255,.05);
  display:flex; gap:10px; align-items:flex-start;
  margin-bottom:10px;
}
.edu-badge{
  font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px;
  background:#FF3B5C; color:#fff; white-space:nowrap;
}
.edu-title{ font-weight:900; }
.edu-meta{ font-size:12px; opacity:.7; margin-top:4px; }

/* âœ… MyInfo Modal (ë‹¨ì¼/ì•ˆì • ë²„ì „) */
.mi-overlay{
  position: fixed; inset: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.45);
  z-index: 9999;
  padding: 16px;
}
.mi-overlay.is-open{ display: grid; }

.mi-modal{
  width: min(720px, 100%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 18px 60px rgba(0,0,0,.25);
  overflow: hidden;
}

.mi-head{
  display: flex; justify-content: space-between; align-items: flex-start;
  padding: 16px 16px 10px;
  border-bottom: 1px solid rgba(0,0,0,.08);
}
.mi-title{ font-size: 18px; font-weight: 800; letter-spacing: -0.2px; }
.mi-sub{ margin-top: 6px; font-size: 12px; color: rgba(0,0,0,.6); line-height: 1.4; }
.mi-x{
  border: 0; background: transparent;
  font-size: 18px; cursor: pointer;
  width: 36px; height: 36px; border-radius: 10px;
}
.mi-x:hover{ background: rgba(0,0,0,.06); }

.mi-body{ padding: 14px 16px 6px; }

.mi-foot{
  display: flex; gap: 10px; justify-content: flex-end;
  padding: 12px 16px 14px;
  border-top: 1px solid rgba(0,0,0,.08);
}

.mi-btn{
  border: 0;
  padding: 10px 14px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
}
.mi-btn-ghost{ background: rgba(0,0,0,.06); }
.mi-btn-ghost:hover{ background: rgba(0,0,0,.10); }
.mi-btn-primary{ background: #1d4ed8; color: #fff; }
.mi-btn-primary:hover{ filter: brightness(0.95); }

.mi-grid{
  display: grid;
  grid-template-columns: 1.3fr 1fr;
  gap: 12px;
}
@media (max-width: 680px){
  .mi-grid{ grid-template-columns: 1fr; }
}

.mi-card{
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 14px;
  padding: 12px;
  background: #fff;
}
.mi-row{ display: flex; justify-content: space-between; gap: 10px; }
.mi-label{ color: rgba(0,0,0,.55); font-size: 12px; }
.mi-value{ font-weight: 800; }

.mi-badge{
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
}
.mi-badge.ok{ background: rgba(16,185,129,.12); color: #047857; }
.mi-badge.warn{ background: rgba(245,158,11,.14); color: #92400e; }
.mi-badge.neutral{ background: rgba(59,130,246,.12); color: #1d4ed8; }

.mi-list{ margin-top: 12px; display: grid; gap: 10px; }
.mi-item{
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 14px;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
  align-items: center;
}
.mi-item-title{ font-weight: 900; }
.mi-item-meta{ margin-top: 6px; font-size: 12px; color: rgba(0,0,0,.55); line-height: 1.35; }
.mi-item-actions{ display: flex; gap: 8px; flex-shrink: 0; }
.mi-smallbtn{
  border: 0; cursor: pointer;
  padding: 9px 12px;
  border-radius: 12px;
  font-weight: 800;
  background: rgba(0,0,0,.06);
}
.mi-smallbtn:hover{ background: rgba(0,0,0,.10); }
.mi-smallbtn.primary{ background: #1d4ed8; color: #fff; }
.mi-smallbtn.primary:hover{ filter: brightness(0.95); }

.mi-empty{
  padding: 14px;
  border-radius: 14px;
  background: rgba(0,0,0,.04);
  color: rgba(0,0,0,.65);
  line-height: 1.5;
}

/* âœ… ì´ë¦„ pill hover íš¨ê³¼ */
#userNamePill:hover {
  background: rgba(255,255,255,.28) !important;
  transform: scale(1.05);
}

#userNamePill:active {
  transform: scale(0.98);
}


  </style>
</head>

<body>
  <div class="app" id="app">
    <header class="top">
      <div class="top-row">
        <div class="brand">
          <div class="logo">MSL</div>
          <div class="brand-title">
            <b>MSL ì•ˆì „ë³´ê±´ê´€ë¦¬ í”Œë«í¼</b>
            <span>MSL Digital Safety Platform v2.0</span>
          </div>
        </div>

        <div class="top-actions">
          <button class="icon-btn" id="btnTheme" aria-label="í…Œë§ˆ ì „í™˜">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M21 12.8A8.5 8.5 0 0 1 11.2 3a7 7 0 1 0 9.8 9.8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="icon-btn" id="btnAdmin" aria-label="ê´€ë¦¬ì">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19.4 15a1.7 1.7 0 0 0 .3 1.9l.1.1a2 2 0 0 1-1.5 3.3 2 2 0 0 1-1.4-.6l-.1-.1a1.7 1.7 0 0 0-1.9-.3 1.7 1.7 0 0 0-1 1.6V21a2 2 0 0 1-4 0v-.1a1.7 1.7 0 0 0-1.1-1.6 1.7 1.7 0 0 0-1.9.3l-.1.1a2 2 0 0 1-3.3-1.5 2 2 0 0 1 .6-1.4l.1-.1a1.7 1.7 0 0 0 .3-1.9 1.7 1.7 0 0 0-1.6-1H3a2 2 0 0 1 0-4h.1a1.7 1.7 0 0 0 1.6-1.1 1.7 1.7 0 0 0-.3-1.9l-.1-.1a2 2 0 0 1 1.5-3.3 2 2 0 0 1 1.4.6l.1.1a1.7 1.7 0 0 0 1.9.3h.1a1.7 1.7 0 0 0 1-1.6V3a2 2 0 0 1 4 0v.1a1.7 1.7 0 0 0 1.1 1.6 1.7 1.7 0 0 0 1.9-.3l.1-.1a2 2 0 0 1 3.3 1.5 2 2 0 0 1-.6 1.4l-.1.1a1.7 1.7 0 0 0-.3 1.9v.1a1.7 1.7 0 0 0 1.6 1H21a2 2 0 0 1 0 4h-.1a1.7 1.7 0 0 0-1.6 1.1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="hero">
        <div class="hero-head">
          <div>
            <h1>ãˆœì— ì—ìŠ¤ì—˜ì½¤í”„ë ˆì„œ</h1>
            <p>ì•ˆì „ë³´ê±´ê´€ë¦¬ì±…ì„ì: ì„±ì‹œë¯¼ ëŒ€í‘œ / í˜„ì¥ê´€ë¦¬ê°ë…ì: ì„ì •í˜¸ Pro</p>
          </div>
          <div class="chip" id="dateChip">ì˜¤ëŠ˜</div>
        </div>

        <div class="pill-row" id="pillRow">
  <div class="pill"><span class="dot"></span>ì¤‘ëŒ€ì¬í•´ ZERO</div>
  <div class="pill"><span class="dot"></span>ì•„ì°¨ì‚¬ê³  ë°œêµ´ 1ì¸ë‹¹ 2ê±´</div>
  <div class="pill" id="userNamePill" style="cursor: pointer; transition: all .2s ease;" onclick="openNameChangeModal()">
    <span class="dot"></span>
    <span id="userNameText">ë¡œë”©ì¤‘...</span>
  </div>
</div>

        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="sign">ì•ˆì „ë³´ê±´ìë£Œ&TBM <span class="badge" id="badgeSign">0</span></button>
          <button class="tab" data-tab="vehicle">ì°¨ëŸ‰ê´€ë¦¬ <span class="badge" id="badgeVehicle">0</span></button>
          <button class="tab" data-tab="admin">ê´€ë¦¬ <span class="badge" id="badgeAdmin">0</span></button>
        </div>
      </div>
    </header>

    <main class="content">
      <section class="tab-panel fade-in" id="panel-sign">
        <div class="section-title">
          <h2>ì•ˆì „ë³´ê±´ ìë£Œ ë° TBM ì²´í¬í˜„í™©</h2>
          <span>í•„ìˆ˜ ë¬¸ì„œ ìš°ì„  ì²˜ë¦¬</span>
        </div>
        <div class="grid" id="signGrid">
          <div class="loading">ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>

      <section class="tab-panel hide" id="panel-vehicle">
        <div class="section-title">
          <h2>ì‚¬ë‚´ì°¨ëŸ‰ ì •ë¹„ë‚´ì—­</h2>
          <span>ì°¨ëŸ‰ë³„ ìµœê·¼ ì •ë¹„ í˜„í™©</span>
        </div>
        <div class="grid" id="vehicleGrid">
          <div class="loading">ì°¨ëŸ‰ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>

      <section class="tab-panel hide" id="panel-admin">
        <div class="section-title">
          <h2>ê´€ë¦¬ì ë„êµ¬</h2>
          <span>ê²Œì‹œÂ·í†µê³„Â·ë‚´ë³´ë‚´ê¸°</span>
        </div>
        <div class="grid" id="adminGrid">
          <div class="loading">ê¶Œí•œ í™•ì¸ ì¤‘...</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <button class="navbtn active" data-nav="home">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        í™ˆ
      </button>
      <button class="navbtn" data-nav="suggest" id="btnSuggest">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        ì œì•ˆí•˜ê¸°
      </button>
      <button class="navbtn" data-nav="profile" id="btnProfile">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        ë‚´ì •ë³´
      </button>
    </div>
  </div>

  <!-- Bottom Sheet (ì œì•ˆí•˜ê¸°) -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="grab"></div>
    <div class="sheet-head">
      <b>ğŸ’¡ ì•„ì°¨ì‚¬ê³  ì œì•ˆí•˜ê¸°</b>
      <button class="icon-btn" id="btnClose" aria-label="ë‹«ê¸°" style="box-shadow:none;">
        <svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="sheet-body">
      <div class="field">
        <div class="label">ë¶„ë¥˜</div>
        <select class="select" id="sType">
          <option>ì•„ì°¨ì‚¬ê³ </option>
          <option>ê°œì„  ì œì•ˆ</option>
          <option>ë¶ˆì•ˆì „ ìƒíƒœ</option>
          <option>ë¶ˆì•ˆì „ í–‰ë™</option>
        </select>
      </div>
      <div class="field">
        <div class="label">ë°œê²¬ ë¶€ì„œ</div>
        <select class="select" id="sDept">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì œì¡°íŒ€">ì¡°ë¦½1íŒ€</option>
          <option value="ê±´ì„¤íŒ€">ì¡°ë¦½2íŒ€</option>
          <option value="ë¬¼ë¥˜íŒ€">ê°€ê³µë°˜</option>
          <option value="ë¬¼ë¥˜íŒ€">ì „ê¸°ì‹¤</option>
          <option value="ë¬¼ë¥˜íŒ€">í…ŒìŠ¤íŠ¸ë£¸</option>
          <option value="ì„¤ë¹„íŒ€">ìì¬ì°½ê³ </option>
          <option value="ê´€ë¦¬íŒ€">ì‚¬ë¬´ì‹¤</option>
          <option value="ê´€ë¦¬íŒ€">ê¸°íƒ€ì¥ì†Œ</option>
        </select>
      </div>
      <div class="field">
        <div class="label">ë‚´ìš©</div>
        <textarea class="textarea" id="sMsg" placeholder="ë¬´ì—‡ì´ ìœ„í—˜í–ˆëŠ”ì§€, ì–´ë–»ê²Œ ê°œì„ í•˜ë©´ ì¢‹ì„ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>
      </div>
      <div class="field">
        <div class="label">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</div>
        <div style="position: relative;">
          <input type="file" id="sImage" accept="image/*" style="display: none;">
          <button type="button" class="file-upload-btn" onclick="document.getElementById('sImage').click()">
            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px;">
              <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
              <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
              <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="fileLabel">ì‚¬ì§„ ì„ íƒ (ì„ íƒì‚¬í•­)</span>
          </button>
          <div id="imagePreview" style="display: none; margin-top: 10px;">
            <img id="previewImg" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px; border: 1px solid var(--stroke);">
            <button type="button" class="btn ghost" onclick="removeImage()" style="margin-top: 8px; width: 100%;">
              ğŸ—‘ï¸ ì‚¬ì§„ ì œê±°
            </button>
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 6px; font-weight: 600;">
            ğŸ’¡ ì‚¬ì§„ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤. ì‚¬ì§„ ì—†ì´ë„ ì œì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn ghost" id="btnSaveDraft">ì„ì‹œì €ì¥</button>
      <button class="btn primary" id="btnSubmit">ì œì¶œí•˜ê¸°</button>
    </div>
  </div>

  <!-- ì„œëª… ëª¨ë‹¬ -->
  <div class="modal" id="signatureModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœ… ì•ˆì „ë³´ê±´ìë£Œ í™•ì¸</h3>
        <button class="icon-btn" onclick="closeSignatureModal()" style="box-shadow:none; width:36px; height:36px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="documentToSign"></div>
        <div class="field">
          <div class="label">ì´ë¦„</div>
          <input type="text" id="signerName" class="input" placeholder="ì´ë¦„" required>
        </div>
        <div class="field">
          <div class="label">ë¶€ì„œ</div>
          <input type="text" id="signerDept" class="input" placeholder="ë¶€ì„œ" required>
        </div>
        <div class="cta">
          <button class="btn primary" onclick="saveSignature()" style="width: 100%;">TBM ë° ì•ˆì „ë³´ê±´ìë£Œ í™•ì¸ì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

    <!-- ë‚´ì •ë³´(í”„ë¡œí•„) ëª¨ë‹¬ -->
  <div id="myInfoModal" class="mi-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ‘¤ ë‚´ì •ë³´</h3>
        <button class="icon-btn" id="myInfoCloseBtn" style="box-shadow:none; width:36px; height:36px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body" id="myInfoBody" style="max-height: 70vh; overflow-y:auto;">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>
    </div>
  </div>


  <script>
    // =========================
    // Firebase ì„¤ì •
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyCJb4TXRVPH9sHHrLiaB13jNQY4Hz9zRgc",
      authDomain: "msl-safety-system.firebaseapp.com",
      projectId: "msl-safety-system",
      storageBucket: "msl-safety-system.firebasestorage.app",
      messagingSenderId: "601750720539",
      appId: "1:601750720539:web:1d0839177beb893265268be"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    db.enablePersistence().catch(err => {
      console.log('ì˜¤í”„ë¼ì¸ ìºì‹±:', err.code);
    });

    // =========================
    // ì „ì—­ ë³€ìˆ˜
    // =========================
    let PENDING_DOCS_ALL = [];
    let documents = [];
    let signatures = [];
    let vehicles = [];

    let currentDocumentId = null;
    let isAdmin = false;

    let editingVehicleId = null;

    const ADMIN_PASSWORD = 'msl2024';
    const employees = [
      'í•¨ì¬ì›', 'ì¡°ì ìˆ™', 'ì´ëª…í—Œ', 'ì–‘í¬ë§Œ', 'ì´ë¬¸ìš°',
      'ì„ì •í˜¸', 'ì„œê°‘ìˆ ', 'ê¹€ìš©ì¶˜', 'í™©ëª…ì§„', 'ë°•í™”ìš©',
      'ì´ì™„ë³µ', 'ë…¸ì„ ì', 'ì´ìŠ¹í˜„', 'ê¹€ìš©ì§„', 'ì–‘ì •ëª¨',
      'ìµœí˜„ê²½', 'í•œê²½ì•„', 'ë°•íƒœìœ¨', 'ìœ íš¨ë¹ˆ', 'ì§€ëŒ€ì¤€',
      'ìœ¤ë‹¤ì€', 'ì„±ì‹œë¯¼',
    ];

    // ê³ ì • TBM ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©
    const FIXED_TBM_ITEMS = [
      'ê°œì¸ ë³´í˜¸êµ¬ ì°©ìš©',
      'ìœ„í—˜ìš”ì†Œ ë°œê²¬ì‹œ ì‘ì—…ì¤‘ì§€ ë° ë³´ê³ ',
      'êµìœ¡ ë° ì•ˆì „ê´€ë¦¬ ê·œì • ì¤€ìˆ˜'
    ];

    // =========================
    // ìœ í‹¸
    // =========================
    function escapeHTML(str){
      if(str === null || str === undefined) return '';
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function toDateInputValue(date){
      if(!date) return '';
      const d = new Date(date);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function tsFromDateInput(value){
      if(!value) return null;
      const d = new Date(value + "T00:00:00");
      return firebase.firestore.Timestamp.fromDate(d);
    }

    // =========================
    // Toast
    // =========================
    let toastTimer = null;
    function toast(message){
      clearTimeout(toastTimer);
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.cssText = `
          position: fixed;
          left: 50%;
          transform: translateX(-50%);
          bottom: 92px;
          width: min(420px, calc(100% - 24px));
          padding: 12px 14px;
          border-radius: 16px;
          border: 1px solid var(--stroke);
          background: var(--surface);
          backdrop-filter: blur(12px);
          box-shadow: var(--shadow);
          color: var(--text);
          font-weight: 900;
          font-size: 13px;
          z-index: 999;
          opacity: 0;
          transition: opacity .15s ease, transform .15s ease;
          text-align: center;
        `;
        document.body.appendChild(el);
      }
      el.textContent = message;
      el.style.opacity = "1";
      el.style.transform = "translateX(-50%) translateY(0)";
      toastTimer = setTimeout(() => {
        el.style.opacity = "0";
        el.style.transform = "translateX(-50%) translateY(6px)";
      }, 1400);
    }

    // =========================
    // Tabs
    // =========================
    const tabs = document.querySelectorAll(".tab");
    const panels = {
      sign: document.getElementById("panel-sign"),
      vehicle: document.getElementById("panel-vehicle"),
      admin: document.getElementById("panel-admin")
    };

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const key = btn.dataset.tab;
        Object.keys(panels).forEach(k => panels[k].classList.add("hide"));
        panels[key].classList.remove("hide");
        panels[key].classList.remove("fade-in");
        void panels[key].offsetWidth;
        panels[key].classList.add("fade-in");

        if(key === 'sign') loadPendingDocuments();
        if(key === 'vehicle') loadVehicles();
        if(key === 'admin') loadManageData();
      });
    });

    // =========================
    // Theme
    // =========================
    const btnTheme = document.getElementById("btnTheme");
    const THEME_KEY = "msl_theme";

    function setTheme(mode){
      document.documentElement.setAttribute("data-theme", mode);
      localStorage.setItem(THEME_KEY, mode);
    }

    btnTheme.addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme");
      setTheme(cur === "dark" ? "light" : "dark");
      toast(cur === "dark" ? "â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ" : "ğŸŒ™ ë‹¤í¬ ëª¨ë“œ");
    });

    const saved = localStorage.getItem(THEME_KEY);
    if(saved) setTheme(saved);

    // =========================
    // Admin
    // =========================
    document.getElementById('btnAdmin').addEventListener('click', () => {
      if (isAdmin) {
        if (confirm('ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          isAdmin = false;
          updateAdminUI();
        }
      } else {
        const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:');
        if (password === ADMIN_PASSWORD) {
          isAdmin = true;
          updateAdminUI();
          toast('âœ… ê´€ë¦¬ì ëª¨ë“œ');
        } else if (password !== null) {
          toast('âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
        }
      }
    });

    function updateAdminUI() {
      loadManageData();
      updateBadges();
    }

    // =========================
    // Bottom sheet (ì œì•ˆ)
    // =========================
    const overlay = document.getElementById("overlay");
    const sheet = document.getElementById("sheet");
    const btnSuggest = document.getElementById("btnSuggest");
    const btnClose = document.getElementById("btnClose");
    const btnSaveDraft = document.getElementById("btnSaveDraft");
    const btnSubmit = document.getElementById("btnSubmit");

    function openSheet(){
      overlay.classList.add("show");
      sheet.classList.add("show");
    }
    function closeSheet(){
      overlay.classList.remove("show");
      sheet.classList.remove("show");
    }

    btnSuggest.addEventListener("click", () => {
      openSheet();
      setNav("suggest");
    });
    btnClose.addEventListener("click", closeSheet);
    overlay.addEventListener("click", closeSheet);

    document.getElementById('sImage').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById('previewImg').src = event.target.result;
          document.getElementById('imagePreview').style.display = 'block';
          document.getElementById('fileLabel').textContent = file.name;
        };
        reader.readAsDataURL(file);
      }
    });

    function removeImage() {
      document.getElementById('sImage').value = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('fileLabel').textContent = 'ì‚¬ì§„ ì„ íƒ';
    }

    // Nav
    const navBtns = document.querySelectorAll(".navbtn");
    function setNav(key){
      navBtns.forEach(b => b.classList.remove("active"));
      document.querySelector(`.navbtn[data-nav="${key}"]`)?.classList.add("active");
    }
    navBtns.forEach(b => {
      b.addEventListener("click", () => {
        const key = b.dataset.nav;
        if(key !== "suggest"){
          closeSheet();
          setNav(key);
          if(key === "profile") openMyInfoModalAndLoad();
        }
      });
    });

    function showProfile() {
      const userName = localStorage.getItem('mslUserName') || 'ìµëª…';
      toast(`ğŸ‘¤ ${userName}ë‹˜`);
    }

    // Draft/Submit (ì•„ì°¨ì‚¬ê³ )
    function getForm(){
      return {
        type: document.getElementById("sType").value,
        dept: document.getElementById("sDept").value.trim(),
        msg: document.getElementById("sMsg").value.trim(),
        image: document.getElementById("sImage").files[0]
      };
    }

    btnSaveDraft.addEventListener("click", () => {
      const data = getForm();
      localStorage.setItem("msl_suggest_draft", JSON.stringify({
        type: data.type,
        dept: data.dept,
        msg: data.msg
      }));
      toast("ğŸ’¾ ì„ì‹œì €ì¥ ì™„ë£Œ");
    });

    btnSubmit.addEventListener("click", async () => {
      const data = getForm();
      const userName = localStorage.getItem('mslUserName');

      if(!userName) {
        toast('âš ï¸ ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        showNameInputModal();
        return;
      }

      if(!data.dept || !data.msg){
        toast("âš ï¸ ë¶€ì„œ/ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      }

      btnSubmit.textContent = "ì œì¶œ ì¤‘...";
      btnSubmit.disabled = true;

      try {
        let imageUrl = '';

        if (data.image) {
          try {
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`nearmiss_images/${Date.now()}_${data.image.name}`);

            const uploadPromise = imageRef.put(data.image);
            const timeoutPromise = new Promise((_, reject) =>
              setTimeout(() => reject(new Error('ì—…ë¡œë“œ ì‹œê°„ ì´ˆê³¼')), 10000)
            );

            const uploadTask = await Promise.race([uploadPromise, timeoutPromise]);
            imageUrl = await uploadTask.ref.getDownloadURL();
            toast('ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
          } catch (imageError) {
            toast('âš ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ - í…ìŠ¤íŠ¸ë§Œ ì œì¶œí•©ë‹ˆë‹¤');
            imageUrl = '';
          }
        }

        await db.collection('nearmiss').add({
          submitterName: userName,
          submitterDept: data.dept,
          content: data.msg,
          imageUrl: imageUrl,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          year: new Date().getFullYear()
        });

        localStorage.removeItem("msl_suggest_draft");
        toast("âœ… ì œì¶œ ì™„ë£Œ");
        closeSheet();

        document.getElementById("sMsg").value = "";
        document.getElementById("sDept").value = "";
        document.getElementById("sImage").value = "";
        removeImage();

        if (isAdmin) {
          setTimeout(() => {
            const currentTab = document.querySelector('.tab.active')?.dataset.tab;
            if (currentTab === 'admin') loadManageData();
          }, 600);
        }
      } catch(error) {
        toast(`âŒ ì œì¶œ ì‹¤íŒ¨: ${error.message}`);
      } finally {
        btnSubmit.textContent = "ì œì¶œí•˜ê¸°";
        btnSubmit.disabled = false;
      }
    });

    // Load draft
    const draft = localStorage.getItem("msl_suggest_draft");
    if(draft){
      try{
        const d = JSON.parse(draft);
        if(d.type) document.getElementById("sType").value = d.type;
        if(d.dept) document.getElementById("sDept").value = d.dept;
        if(d.msg) document.getElementById("sMsg").value = d.msg;
      }catch(e){}
    }

    // =========================
    // Firebase Data Load
    // =========================
    async function loadDocumentsFromFirebase() {
  try {
    const snapshot = await db.collection('documents')
      .orderBy('createdAt', 'desc')   // createdAt ì—†ìœ¼ë©´ ì œê±° ê°€ëŠ¥
      .get();

    documents = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    return documents;
  } catch (error) {
    console.error('ë¬¸ì„œ ë¡œë“œ ì˜¤ë¥˜:', error);
    documents = [];
    return [];
  }
}


    async function loadSignaturesFromFirebase() {
      try {
        const snapshot = await db.collection('signatures').orderBy('signedAt', 'desc').get();
        signatures = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return signatures;
      } catch (error) {
        console.error('ì„œëª… ë¡œë“œ ì˜¤ë¥˜:', error);
        return [];
      }
    }

    async function loadVehiclesFromFirebase() {
      try{
        // updatedAtì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ createdAtë„ í•¨ê»˜ ê³ ë ¤
        const snapshot = await db.collection('vehicles').orderBy('updatedAt', 'desc').get();
        vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return vehicles;
      }catch(err){
        console.error('ì°¨ëŸ‰ ë¡œë“œ ì˜¤ë¥˜:', err);
        vehicles = [];
        return [];
      }
    }

    // =========================
    // Pending Docs (ì„œëª… íƒ­)
    // =========================
    async function loadPendingDocuments() {
      const container = document.getElementById('signGrid');
      container.innerHTML = '<div class="loading">ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      await loadDocumentsFromFirebase();
      await loadSignaturesFromFirebase();

      const userName = localStorage.getItem('mslUserName');
      if (!userName) {
        showNameInputModal();
        return;
      }

      const pendingDocs = documents.filter(doc => {
        const docSigs = signatures.filter(s => s.documentId === doc.id);
        const mySignature = docSigs.find(s => s.signerName === userName);
        return !mySignature;
      });

      // âœ… (í•µì‹¬) ë¯¸ì„œëª… ë¬¸ì„œ ì „ì²´ë¥¼ ì „ì—­ì— ì €ì¥ (ìµœì‹ ìˆœ)
PENDING_DOCS_ALL = pendingDocs
  .slice()
  .sort((a,b) => (b.createdAt?.toMillis?.() ?? 0) - (a.createdAt?.toMillis?.() ?? 0));

      if (pendingDocs.length === 0) {
        container.innerHTML = `
          <div class="empty">
            <div class="mail">ğŸ‰</div>
            <div>
              <b>ì•ˆì „ë³´ê±´íšŒëŒ ìë£Œ í™•ì¸ ì™„ë£Œ!</b>
              <span>í˜„ì¬ í™•ì¸ì´ í•„ìš”í•œ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
          </div>
        `;
        updateBadges();
        return;
      }

      // âœ… ì—¬ê¸°ê¹Œì§€ pendingDocs ê³„ì‚° + PENDING_DOCS_ALL ì €ì¥ì€ ê·¸ëŒ€ë¡œ ë‘ê³ ...

// ë‹¬ë ¥ í‘œì‹œìš© ë¬¸ì„œ ë‚ ì§œ ëª©ë¡
const documentDates = documents
  .map(doc => {
    if (!doc.createdAt) return null;
    const date = doc.createdAt.toDate();
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  })
  .filter(Boolean);

// âœ… ìµœì‹  ë¯¸ì„œëª… ë¬¸ì„œ 1ê±´ë§Œ ë½‘ê¸° (ì›í•˜ëŠ” ê°œìˆ˜ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
const latestOnly = PENDING_DOCS_ALL.slice(0, 1);

container.innerHTML = latestOnly.map(doc => {
  const docSigs = signatures.filter(s => s.documentId === doc.id);
  const signedCount = docSigs.length;
  const unsignedCount = employees.length - signedCount;
  const completionRate = employees.length ? Math.round((signedCount / employees.length) * 100) : 0;

  return `
    <article class="card">
      <div class="card-head">
        <div class="left">
          <div class="emoji">âœï¸</div>
          <div class="title">
            <b>${escapeHTML(doc.title)}</b>
            <span>ë¯¸í™•ì¸ì¸ì›  ${unsignedCount}ëª…</span>
          </div>
        </div>
        <div class="status-chip red">ê¸´ê¸‰</div>
      </div>

      <div class="card-body">
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
            <div style="font-size: 13px; font-weight: 800; color: var(--text);">í™•ì¸ ì§„í–‰ë¥ </div>
            <div style="font-size: 18px; font-weight: 900; color: var(--primary);">${completionRate}%</div>
          </div>

          <div style="position: relative; height: 10px; background: rgba(43,107,255,.12); border-radius: 999px; overflow: hidden; border: 1px solid rgba(43,107,255,.20);">
            <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${completionRate}%; background: linear-gradient(90deg, #12B76A, #10D97F); border-radius: 999px; transition: width .3s ease;"></div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 12px; background: rgba(18,183,106,.08); border: 1px solid rgba(18,183,106,.15);">
              <div style="width: 8px; height: 8px; border-radius: 999px; background: #12B76A;"></div>
              <div style="flex: 1;">
                <div style="font-size: 11px; color: var(--muted); font-weight: 700;">ì™„ë£Œ</div>
                <div style="font-size: 16px; font-weight: 900; color: #12B76A; margin-top: 2px;">
                  ${signedCount}<span style="font-size: 11px; font-weight: 700; color: var(--muted);"> / ${employees.length}ëª…</span>
                </div>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 12px; background: rgba(255,59,92,.08); border: 1px solid rgba(255,59,92,.15);">
              <div style="width: 8px; height: 8px; border-radius: 999px; background: #FF3B5C;"></div>
              <div style="flex: 1;">
                <div style="font-size: 11px; color: var(--muted); font-weight: 700;">ë¯¸ì™„ë£Œ</div>
                <div style="font-size: 16px; font-weight: 900; color: #FF3B5C; margin-top: 2px;">
                  ${unsignedCount}<span style="font-size: 11px; font-weight: 700; color: var(--muted);">ëª…</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="cta">
          <button class="btn primary" data-open-doc="${doc.id}" style="width: 100%;">âœ… í™•ì¸í•˜ê¸°</button>
        </div>

        <button class="btn-nearmiss" onclick="openNearmissFromDoc('${doc.id}')">
          <div class="btn-nearmiss-icon">ğŸ’¡</div>
          <div class="btn-nearmiss-content">
            <div class="btn-nearmiss-title">ì•„ì°¨ì‚¬ê³  Â· ê°œì„ ì‚¬í•­ ì œì•ˆí•˜ê¸°</div>
            <div class="btn-nearmiss-desc">í˜„ì¥ì—ì„œ ë°œê²¬í•œ ìœ„í—˜ìš”ì†Œë¥¼ ì¦‰ì‹œ ì œë³´í•´ì£¼ì„¸ìš”</div>
          </div>
          <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; opacity: .6;">
            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="calendar-container" id="calendar-${doc.id}">
          ${generateCalendar(documentDates)}
        </div>
      </div>
    </article>
  `;
}).join('');


      updateBadges();
    }

// =========================
// âœ… ë©”ì¸ ì¹´ë“œ "í™•ì¸í•˜ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (1íšŒë§Œ)
// =========================
(function bindOpenDocButtonsOnce(){
  const grid = document.getElementById('signGrid');
  if(!grid) return;

  // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
  if(grid.__openDocBound) return;
  grid.__openDocBound = true;

  grid.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-open-doc]');
    if(!btn) return;

    const docId = btn.dataset.openDoc;
    if(!docId) return;

    openSignatureModal(docId);
  });
})();



    function openNearmissFromDoc(docId) {
      openSheet();
      setNav("suggest");
    }

    // =========================
    // Calendar
    // =========================
    let currentCalendarDate = new Date();
    let selectedDate = null;

    function generateCalendar(documentDates = []) {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay();

      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

      let calendarHTML = `
        <div class="calendar-header">
          <button class="calendar-nav" onclick="changeMonth(-1)">
            <svg viewBox="0 0 24 24" fill="none" style="width: 18px; height: 18px;">
              <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="calendar-title">${year}ë…„ ${monthNames[month]}</div>
          <button class="calendar-nav" onclick="changeMonth(1)">
            <svg viewBox="0 0 24 24" fill="none" style="width: 18px; height: 18px;">
              <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="calendar-weekdays">
          ${dayNames.map((day, i) => `<div class="calendar-weekday" style="color: ${i === 0 ? '#FF3B5C' : i === 6 ? '#2B6BFF' : 'var(--muted)'}">${day}</div>`).join('')}
        </div>

        <div class="calendar-days">
      `;

      for (let i = 0; i < startDayOfWeek; i++) {
        calendarHTML += `<div class="calendar-day empty"></div>`;
      }

      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
        const hasDocument = documentDates.includes(dateStr);
        const isSelected = selectedDate === dateStr;
        const dayOfWeek = new Date(year, month, day).getDay();

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasDocument) classes += ' has-document';
        if (isSelected) classes += ' selected';

        let style = '';
        if (dayOfWeek === 0) style = 'color: #FF3B5C;';
        if (dayOfWeek === 6) style = 'color: #2B6BFF;';

        const onclick = hasDocument ? `onclick="showDocumentsByDate('${dateStr}')"` : '';

        calendarHTML += `
          <div class="${classes}" style="${style}" ${onclick}>
            <div class="calendar-day-number">${day}</div>
            ${hasDocument ? '<div class="calendar-dot"></div>' : ''}
          </div>
        `;
      }

      calendarHTML += `
        </div>
        <div class="calendar-legend">
          <div class="legend-item">
            <div class="legend-dot"></div>
            <span>ìë£Œ ë“±ë¡ì¼ (í´ë¦­í•˜ì—¬ ë³´ê¸°)</span>
          </div>
        </div>
      `;

      return calendarHTML;
    }

    function changeMonth(delta) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
      selectedDate = null;
      loadPendingDocuments();
    }

    async function showDocumentsByDate(dateStr) {
  selectedDate = dateStr;

  // âœ… ë‚ ì§œë³„ ë¬¸ì„œ í•„í„°ë§
  const dateDocuments = documents.filter(doc => {
    if (!doc.createdAt) return false;
    const docDate = doc.createdAt.toDate();
    const docDateStr = `${docDate.getFullYear()}-${String(docDate.getMonth() + 1).padStart(2, '0')}-${String(docDate.getDate()).padStart(2, '0')}`;
    return docDateStr === dateStr;
  });

  if (dateDocuments.length === 0) {
    toast('í•´ë‹¹ ë‚ ì§œì— ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  // âœ… ì‚¬ìš©ì ì´ë¦„ í™•ì¸
  const userName = localStorage.getItem('mslUserName');
  if (!userName) {
    showNameInputModal();
    return;
  }

  // âœ… ëª¨ë‹¬ ìƒì„±
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.style.display = 'flex';

  // âœ… ë‚ ì§œ í‘œì‹œ(ë¡œì»¬ íŒŒì‹± ì•ˆì „)
  const [y, m, d] = dateStr.split('-').map(Number);
  const formattedDate = new Date(y, m - 1, d).toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  // âœ… ë¬¸ì„œ ì¹´ë“œ HTML ìƒì„± (ì¸ë¼ì¸ onclick ì œê±° + data-open-doc ì‚¬ìš©)
  const docsHTML = dateDocuments.map(doc => {
    const docSigs = signatures.filter(s => s.documentId === doc.id);
    const mySignature = docSigs.find(s => s.signerName === userName);
    const isCompleted = !!mySignature;
    const completionRate = employees.length ? Math.round((docSigs.length / employees.length) * 100) : 0;

    if (isCompleted) {
      return `
        <div style="padding: 16px; border-radius: 16px; border: 1px solid var(--stroke); background: linear-gradient(135deg, rgba(18,183,106,.08), rgba(16,217,127,.06)); margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
            <div style="width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(135deg, #12B76A, #10D97F); display: grid; place-items: center; font-size: 22px; flex-shrink: 0;">âœ“</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 14px; font-weight: 800; color: var(--text); margin-bottom: 4px;">${escapeHTML(doc.title)}</div>
              <div style="font-size: 11px; color: var(--muted); font-weight: 600;">ì„œëª… ì™„ë£Œ</div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 12px; background: rgba(18,183,106,.12);">
            <span style="font-size: 12px; font-weight: 800; color: #12B76A;">ì„œëª…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</span>
          </div>
        </div>
      `;
    }

    // âœ… ë¯¸ì™„ë£Œ: data-open-docë¡œ ì´ë²¤íŠ¸ ìœ„ì„ ì²˜ë¦¬
    return `
      <div style="padding: 16px; border-radius: 16px; border: 1px solid var(--stroke); background: var(--surface); margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
          <div style="width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(135deg, #FF3B5C, #FF6B88); display: grid; place-items: center; font-size: 22px; flex-shrink: 0;">âœï¸</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 14px; font-weight: 800; color: var(--text); margin-bottom: 4px;">${escapeHTML(doc.title)}</div>
            <div style="font-size: 11px; color: var(--muted); font-weight: 600;">í™•ì¸ë¥  ${completionRate}% Â· ${docSigs.length}/${employees.length}ëª… ì™„ë£Œ</div>
          </div>
        </div>
        <button class="btn primary" data-open-doc="${doc.id}" style="width: 100%;">
          âœ… í™•ì¸í•˜ê¸°
        </button>
      </div>
    `;
  }).join('');

  // âœ… ëª¨ë‹¬ ë Œë”ë§
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 460px;">
      <div class="modal-header">
        <h3>ğŸ“… ${formattedDate}</h3>
        <button class="icon-btn" data-close-modal style="box-shadow:none; width:36px; height:36px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div style="font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
          ì´ ${dateDocuments.length}ê°œì˜ ë¬¸ì„œ
        </div>
        ${docsHTML}
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // âœ… ì´ë²¤íŠ¸ ìœ„ì„: ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì„œëª… ëª¨ë‹¬ ì—´ê¸°
  modal.addEventListener('click', (e) => {
    // ë‹«ê¸° ë²„íŠ¼
    if (e.target.closest('[data-close-modal]')) {
      modal.remove();
      loadPendingDocuments();
      return;
    }

    // ë¬¸ì„œ ì—´ê¸° ë²„íŠ¼
    const btn = e.target.closest('[data-open-doc]');
    if (!btn) return;

    const docId = btn.dataset.openDoc;
    if (!docId) return;

    // 1) ë‚ ì§œ ëª¨ë‹¬ ë‹«ê¸°
    modal.remove();

    // 2) ì„œëª… ëª¨ë‹¬ ì—´ê¸°
    openSignatureModal(docId);
  });

  // âœ… ë°°ì§€/ëª©ë¡ ê°±ì‹ (ì›ë˜ íë¦„ ìœ ì§€)
  loadPendingDocuments();
}


    function openSignatureModalFromDate(docId) {
      document.querySelectorAll('.modal').forEach(m => {
        if(m.id !== 'signatureModal') m.remove();
      });
      openSignatureModal(docId);
    }

    // =========================
    // Signature Modal
    // =========================
    function openSignatureModal(documentId) {
      currentDocumentId = documentId;
      const doc = documents.find(d => d.id === documentId);
      if(!doc){
        toast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      let contentHtml = '';

      if (doc.content || doc.attachmentUrl) {
        contentHtml += `<div class="doc-content">`;
        contentHtml += `<div class="doc-content-title">ğŸ“„ ìë£Œ ë‚´ìš©</div>`;
        if (doc.content) {
          contentHtml += `<div class="doc-content-text">${escapeHTML(doc.content)}</div>`;
        }
        if (doc.attachmentUrl) {
          contentHtml += `
            <a href="${escapeHTML(doc.attachmentUrl)}" target="_blank" class="btn primary" style="width:100%; margin-top:10px; text-decoration:none; display:flex;">
              ğŸ“ ì•ˆì „ë³´ê±´ ìë£Œ ë³´ê¸°
            </a>
          `;
        }
        contentHtml += `</div>`;
      }

      const tbmItems = (doc.tbmItems && doc.tbmItems.length > 0) ? doc.tbmItems : FIXED_TBM_ITEMS;
      contentHtml += `
        <div class="tbm-section">
          <div class="tbm-title">âœ“ ì¼ì¼ TBM ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
          <div style="font-size:10px; color:var(--muted); margin-bottom:8px; font-weight:600;">í™•ì¸ í›„ ì²´í¬í•´ì£¼ì„¸ìš”</div>
          ${tbmItems.map((item, idx) => `
            <div class="tbm-item">
              <input type="checkbox" class="tbm-checkbox" id="tbm-${idx}" data-item="${escapeHTML(item)}">
              <label class="tbm-label" for="tbm-${idx}">${escapeHTML(item)}</label>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('documentToSign').innerHTML = contentHtml;

      // ìµœê·¼ ì´ë¦„ ìë™ ì±„ì›€
      const savedName = localStorage.getItem('mslUserName') || '';
      if(savedName) document.getElementById('signerName').value = savedName;
      

      // âœ… ì¶”ê°€: ìµœê·¼ ë¶€ì„œ ìë™ ì±„ì›€
const savedDept = localStorage.getItem('mslUserDept') || '';
if(savedDept) document.getElementById('signerDept').value = savedDept;

      document.getElementById('signatureModal').classList.add('show');
    }

    function closeSignatureModal() {
      document.getElementById('signatureModal').classList.remove('show');
      currentDocumentId = null;
      document.getElementById('documentToSign').innerHTML = '';
      document.getElementById('signerName').value = '';
      document.getElementById('signerDept').value = '';
    }

    async function saveSignature() {
      const signerName = document.getElementById('signerName').value.trim();
      const signerDept = document.getElementById('signerDept').value.trim();

      if (!signerName || !signerDept) {
        toast('âš ï¸ ì´ë¦„ê³¼ ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const checklistResults = {};
      const checkboxes = document.querySelectorAll('.tbm-checkbox');
      let allChecked = true;
      checkboxes.forEach(cb => {
        checklistResults[cb.dataset.item] = cb.checked;
        if(!cb.checked) allChecked = false;
      });

      if (!allChecked) {
        toast('âš ï¸ ëª¨ë“  TBM ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
        return;
      }

      try {
        // ì¤‘ë³µ ì„œëª… ë°©ì§€(ê°™ì€ ì‚¬ëŒ ê°™ì€ ë¬¸ì„œ)
        const exists = signatures.find(s => s.documentId === currentDocumentId && s.signerName === signerName);
        if(exists){
          toast('ì´ë¯¸ í™•ì¸ ì²˜ë¦¬ëœ ë¬¸ì„œì…ë‹ˆë‹¤');
          closeSignatureModal();
          loadPendingDocuments();
          return;
        }

        await db.collection('signatures').add({
          documentId: currentDocumentId,
          signerName: signerName,
          signerDept: signerDept,
          checklistResults: checklistResults,
          signedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        localStorage.setItem('mslUserName', signerName);
        localStorage.setItem('mslUserDept', signerDept); // âœ… ì¶”ê°€

        closeSignatureModal();

        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
          colors: ['#2B6BFF', '#4ED0FF', '#FFB800']
        });

        toast(`âœ… ${signerName}ë‹˜ í™•ì¸ì™„ë£Œ!`);

        await loadSignaturesFromFirebase();
        loadPendingDocuments();
        updateBadges();

      } catch (error) {
        toast('âŒ í™•ì¸ ì €ì¥ ì‹¤íŒ¨');
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      }
    }

    // =========================
    // ì´ë¦„ ì…ë ¥ ëª¨ë‹¬
    // =========================
    function showNameInputModal() {
      openNameChangeModal();
      modal.className = 'modal show';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-header">
            <h3>ğŸ‘¤ ì´ë¦„ ì…ë ¥</h3>
          </div>
          <div class="modal-body">
            <div class="field">
              <div class="label">ì´ë¦„</div>
              <input type="text" id="nameInput" class="input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autofocus>
            </div>
            <button class="btn primary" style="width:100%;" onclick="saveName(this)">í™•ì¸</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function saveName(btn) {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) {
        toast('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      localStorage.setItem('mslUserName', name);
      document.querySelector('.modal.show')?.remove();
      toast(`ğŸ‘‹ ${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`);

      setTimeout(() => location.reload(), 300);
    }

    // =========================
    // Badge
    // =========================
    function updateBadges() {
      const userName = localStorage.getItem('mslUserName');
      let signCount = 0;

      if (userName) {
        signCount = documents.filter(doc => {
          const docSigs = signatures.filter(s => s.documentId === doc.id);
          const mySignature = docSigs.find(s => s.signerName === userName);
          return !mySignature;
        }).length;
      }

      document.getElementById('badgeSign').textContent = signCount;
      document.getElementById('badgeAdmin').textContent = isAdmin ? '1' : '0';
      document.getElementById('badgeVehicle').textContent = String(vehicles?.length || 0);
    }

    // =========================
    // ë¬¸ì„œ ë©”ë‰´(ê´€ë¦¬ íƒ­/ëª©ë¡ì—ì„œ ì‚¬ìš©)
    // =========================
    function closeAllMenus(){
      document.querySelectorAll('.doc-menu').forEach(m => {
        m.style.display = 'none';
      });
    }

    function toggleDocMenu(docId){
      const menu = document.getElementById(`menu-${docId}`);
      if (!menu) return;

      const open = (menu.style.display === 'flex');
      closeAllMenus();
      if(!open) menu.style.display = 'flex';
    }

    // ë°”ê¹¥ í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«í˜
    document.addEventListener('click', (e) => {
      const isMenuClick = e.target.closest('.doc-menu');
      const isBtnClick = e.target.closest('.icon-btn');
      if(!isMenuClick && !isBtnClick){
        closeAllMenus();
      }
    });

    function copyDocLink(docId) {
      const url = `${window.location.origin}${window.location.pathname}?doc=${docId}`;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => toast('ğŸ”— ë§í¬ ë³µì‚¬ ì™„ë£Œ'));
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        toast('ğŸ”— ë§í¬ ë³µì‚¬ ì™„ë£Œ');
      }
      toggleDocMenu(docId);
    }

    function showSignatureStatus(docId) {
      const doc = documents.find(d => d.id === docId);
      if(!doc){ toast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      const docSigs = signatures.filter(s => s.documentId === docId);
      const signedNames = docSigs.map(s => s.signerName);
      const unsignedEmployees = employees.filter(emp => !signedNames.includes(emp));

      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
          <div class="modal-header">
            <h3>ğŸ“Š í™•ì¸ í˜„í™©</h3>
            <button class="icon-btn" onclick="this.closest('.modal').remove()" style="box-shadow:none; width:36px; height:36px;">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="modal-body sig-status-modal">
            <div style="background: linear-gradient(135deg, rgba(43,107,255,.08), rgba(78,208,255,.06)); padding: 14px; border-radius: 14px; margin-bottom: 14px;">
              <div style="font-size: 13px; font-weight: 800; margin-bottom: 8px;">${escapeHTML(doc.title)}</div>
              <div style="display: flex; gap: 20px;">
                <div>
                  <div style="font-size: 11px; color: var(--muted); font-weight: 700;">ì™„ë£Œ</div>
                  <div style="font-size: 20px; font-weight: 900; color: var(--success); margin-top: 4px;">${docSigs.length}</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--muted); font-weight: 700;">ë¯¸ì™„ë£Œ</div>
                  <div style="font-size: 20px; font-weight: 900; color: var(--danger); margin-top: 4px;">${unsignedEmployees.length}</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: var(--muted); font-weight: 700;">ì™„ë£Œìœ¨</div>
                  <div style="font-size: 20px; font-weight: 900; color: var(--primary); margin-top: 4px;">${Math.round((docSigs.length / employees.length) * 100)}%</div>
                </div>
              </div>
            </div>

            <div style="font-size: 12px; font-weight: 800; margin-bottom: 8px; color: var(--text);">âœ… í™•ì¸ ì™„ë£Œ (${docSigs.length}ëª…)</div>
            <div class="sig-list">
              ${docSigs.map(sig => `
                <div class="sig-item">
                  <div class="left">
                    <div class="avatar">${escapeHTML(sig.signerName || '').charAt(0)}</div>
                    <div class="info">
                      <b>${escapeHTML(sig.signerName || '')}</b>
                      <span>${escapeHTML(sig.signerDept || '')} Â· ${sig.signedAt ? new Date(sig.signedAt.toDate()).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'ë°©ê¸ˆ'}</span>
                    </div>
                  </div>
                  <div class="check">âœ“</div>
                </div>
              `).join('')}
            </div>

            ${unsignedEmployees.length > 0 ? `
              <div style="font-size: 12px; font-weight: 800; margin: 16px 0 8px; color: var(--text);">â³ ë¯¸í™•ì¸ (${unsignedEmployees.length}ëª…)</div>
              <div class="sig-list">
                ${unsignedEmployees.map(emp => `
                  <div class="sig-item" style="opacity: 0.6;">
                    <div class="left">
                      <div class="avatar" style="background: var(--muted);">${escapeHTML(emp).charAt(0)}</div>
                      <div class="info">
                        <b>${escapeHTML(emp)}</b>
                        <span>ë¯¸í™•ì¸</span>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      toggleDocMenu(docId);
    }

    function downloadExcelReport(docId) {
      const doc = documents.find(d => d.id === docId);
      if(!doc){ toast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      const docSigs = signatures.filter(s => s.documentId === docId);

      const now = new Date();
      const reportDate = now.toLocaleString('ko-KR', {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });

      const docDate = doc.createdAt ? doc.createdAt.toDate().toLocaleDateString('ko-KR', {
        year: 'numeric', month: 'numeric', day: 'numeric'
      }) : '';

      let csv = '\uFEFF';
      csv += 'MSL ì•ˆì „ë³´ê±´ í”Œë«í¼ ë³´ê³ ì„œ\n';
      csv += `ë³´ê³ ì„œ ìƒì„±ì¼ì‹œ,${reportDate}\n\n`;

      csv += '[ë¬¸ì„œ ì •ë³´]\n';
      csv += `ë¬¸ì„œëª…,${(doc.title || '').replaceAll(',',' ')}\n`;
      csv += `ë°°í¬ì¼,${docDate}\n`;
      csv += `ì²´í¬ì¸ì›,${docSigs.length}ëª…\n\n`;

      if (doc.content) {
        csv += '[ìë£Œ ë‚´ìš©]\n';
        csv += `"${String(doc.content).replaceAll('"','""')}"\n\n`;
      }

      csv += '='.repeat(100) + '\n\n';
      csv += '[ì²´í¬ í˜„í™©]\n';
      csv += 'No,ì´ë¦„,ë¶€ì„œ,ì„œëª…ì¼ì‹œ,ì²´í¬1,ì²´í¬2,ì²´í¬3\n';

      docSigs.forEach((sig, index) => {
        const signedAt = sig.signedAt ? new Date(sig.signedAt.toDate()).toLocaleString('ko-KR', {
          year: 'numeric', month: 'numeric', day: 'numeric',
          hour: '2-digit', minute: '2-digit', hour12: true
        }) : '';

        const check1 = sig.checklistResults && sig.checklistResults['ê°œì¸ ë³´í˜¸êµ¬ ì°©ìš©'] ? 'O' : '';
        const check2 = sig.checklistResults && sig.checklistResults['ìœ„í—˜ìš”ì†Œ ë°œê²¬ì‹œ ì‘ì—…ì¤‘ì§€ ë° ë³´ê³ '] ? 'O' : '';
        const check3 = sig.checklistResults && sig.checklistResults['êµìœ¡ ë° ì•ˆì „ê´€ë¦¬ ê·œì • ì¤€ìˆ˜'] ? 'O' : '';

        csv += `${index + 1},"${(sig.signerName||'').replaceAll('"','""')}","${(sig.signerDept||'').replaceAll('"','""')}","${signedAt}",${check1},${check2},${check3}\n`;
      });

      const signedNames = docSigs.map(s => s.signerName);
      const unsignedEmployees = employees.filter(emp => !signedNames.includes(emp));
      unsignedEmployees.forEach((emp, index) => {
        const no = docSigs.length + index + 1;
        csv += `${no},"${emp}","","ë¯¸í™•ì¸",,,\n`;
      });

      csv += '\n' + '='.repeat(100) + '\n\n';
      csv += '[ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„¸]\n';
      csv += 'ì²´í¬1,ê°œì¸ ë³´í˜¸êµ¬ ì°©ìš©\n';
      csv += 'ì²´í¬2,ìœ„í—˜ìš”ì†Œ ë°œê²¬ì‹œ ì‘ì—…ì¤‘ì§€ ë° ë³´ê³ \n';
      csv += 'ì²´í¬3,êµìœ¡ ë° ì•ˆì „ê´€ë¦¬ ê·œì • ì¤€ìˆ˜\n';

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      const filename = `MSL_ì•ˆì „ë³´ê±´_ë³´ê³ ì„œ_${(doc.title||'document')}_${new Date().toISOString().split('T')[0]}.csv`;
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      toast('ğŸ“Š ì—‘ì…€ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ');
      toggleDocMenu(docId);
    }

    function editDocument(docId) {
      const doc = documents.find(d => d.id === docId);
      if(!doc){ toast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
          <div class="modal-header">
            <h3>ğŸ“ ë¬¸ì„œ ìˆ˜ì •</h3>
            <button class="icon-btn" onclick="this.closest('.modal').remove()" style="box-shadow:none; width:36px; height:36px;">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="field">
              <div class="label">ì œëª©</div>
              <input type="text" id="editTitle" class="input" value="${escapeHTML(doc.title)}">
            </div>
            <div class="field">
              <div class="label">ë‚´ìš©</div>
              <textarea id="editContent" class="textarea">${escapeHTML(doc.content || '')}</textarea>
            </div>
            <div class="field">
              <div class="label">ì²¨ë¶€íŒŒì¼ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬)</div>
              <input type="text" id="editAttachment" class="input" value="${escapeHTML(doc.attachmentUrl || '')}">
            </div>
            <div class="cta">
              <button class="btn ghost" onclick="this.closest('.modal').remove()">ì·¨ì†Œ</button>
              <button class="btn primary" onclick="saveDocumentEdit('${docId}', this)">ì €ì¥</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      toggleDocMenu(docId);
    }

    async function saveDocumentEdit(docId, btn) {
      const title = document.getElementById('editTitle').value.trim();
      const content = document.getElementById('editContent').value.trim();
      const attachmentUrl = document.getElementById('editAttachment').value.trim();

      if (!title) {
        toast('âš ï¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      btn.textContent = 'ì €ì¥ ì¤‘...';
      btn.disabled = true;

      try {
        await db.collection('documents').doc(docId).update({
          title: title,
          content: content,
          attachmentUrl: attachmentUrl,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        toast('âœ… ìˆ˜ì • ì™„ë£Œ');
        btn.closest('.modal').remove();

        await loadDocumentsFromFirebase();

        const currentTab = document.querySelector('.tab.active')?.dataset.tab;
        if (currentTab === 'admin') loadManageData();
        else loadPendingDocuments();

      } catch (error) {
        console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
        toast('âŒ ìˆ˜ì • ì‹¤íŒ¨');
        btn.textContent = 'ì €ì¥';
        btn.disabled = false;
      }
    }

    async function deleteDocument(docId, title) {
      const safeTitle = title || 'í•´ë‹¹ ë¬¸ì„œ';
      if (!confirm(`"${safeTitle}" ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ê´€ë ¨ëœ ëª¨ë“  ì„œëª… ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        toggleDocMenu(docId);
        return;
      }

      try {
        await db.collection('documents').doc(docId).delete();

        const signaturesSnapshot = await db.collection('signatures')
          .where('documentId', '==', docId)
          .get();

        const batch = db.batch();
        signaturesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        toast('ğŸ—‘ï¸ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ');

        await loadDocumentsFromFirebase();
        await loadSignaturesFromFirebase();

        const currentTab = document.querySelector('.tab.active')?.dataset.tab;
        if (currentTab === 'admin') loadManageData();
        else loadPendingDocuments();

      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        toast('âŒ ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // =========================
    // ì°¨ëŸ‰ê´€ë¦¬
    // =========================
    function getVehicleStatus(vehicle){
      const nextTs = vehicle?.nextMaintenanceDate;
      if(!nextTs) return { class:'blue', text:'ì •ìƒ' };

      const next = nextTs.toDate ? nextTs.toDate() : new Date(nextTs);
      const today = new Date(); today.setHours(0,0,0,0);
      const next0 = new Date(next); next0.setHours(0,0,0,0);

      const diffDays = Math.round((next0 - today) / (1000*60*60*24));

      if(diffDays < 0) return { class:'red', text:'ì§€ì—°' };
      if(diffDays <= 7) return { class:'orange', text:'ì„ë°•' };
      return { class:'green', text:'ì •ìƒ' };
    }

    async function loadVehicles(){
      const container = document.getElementById('vehicleGrid');
      container.innerHTML = '<div class="loading">ì°¨ëŸ‰ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      await loadVehiclesFromFirebase();

      if (vehicles.length === 0) {
        container.innerHTML = `
          <div class="empty">
            <div class="mail">ğŸš—</div>
            <div>
              <b>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</b>
              <span>ê´€ë¦¬ íƒ­ì—ì„œ ì°¨ëŸ‰ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</span>
            </div>
          </div>
        `;
        updateBadges();
        return;
      }

      container.innerHTML = vehicles.map(vehicle => {
        const status = getVehicleStatus(vehicle);
        const maintDate = vehicle.maintenanceDate ? new Date(vehicle.maintenanceDate.toDate()).toLocaleDateString('ko-KR') : '';
        const nextDate = vehicle.nextMaintenanceDate ? new Date(vehicle.nextMaintenanceDate.toDate()).toLocaleDateString('ko-KR') : '';

        return `
          <div class="doc-wrap" style="position: relative; margin-bottom: 14px;">
            <article class="card">
              <div class="card-head">
                <div class="left">
                  <div class="emoji">ğŸš—</div>
                  <div class="title">
                    <b>${escapeHTML(vehicle.vehicleNumber || '')}</b>
                    <span>${escapeHTML(vehicle.vehicleName || 'ì°¨ëŸ‰ëª… ì—†ìŒ')}</span>
                  </div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <div class="status-chip ${status.class}">${status.text}</div>
                  <button class="icon-btn" onclick="toggleVehicleMenu('${vehicle.id}')" style="box-shadow:none; width:36px; height:36px;">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                      <circle cx="12" cy="5" r="2"/>
                      <circle cx="12" cy="12" r="2"/>
                      <circle cx="12" cy="19" r="2"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="card-body">
                <div style="margin-bottom: 12px;">
                  <div style="font-size: 12px; font-weight: 800; color: var(--muted); margin-bottom: 6px;">ğŸ“‹ ìµœê·¼ ì •ë¹„ë‚´ì—­</div>
                  <div style="padding: 12px; border-radius: 12px; border: 1px solid var(--stroke); background: var(--surface-2);">
                    <div style="font-size: 13px; color: var(--text); line-height: 1.6; white-space: pre-wrap;">${escapeHTML(vehicle.lastMaintenance || 'ì •ë¹„ë‚´ì—­ ì—†ìŒ')}</div>
                    ${maintDate ? `
                      <div style="font-size: 11px; color: var(--muted); margin-top: 8px; font-weight: 600;">
                        ğŸ“… ì •ë¹„ì¼: ${maintDate}
                      </div>
                    ` : ''}
                  </div>
                </div>

                ${nextDate ? `
                  <div style="padding: 10px 12px; border-radius: 10px; background: rgba(255,184,0,.08); border: 1px solid rgba(255,184,0,.2);">
                    <div style="font-size: 11px; font-weight: 700; color: var(--accent);">
                      â° ë‹¤ìŒ ì •ë¹„ ì˜ˆì •: ${nextDate}
                    </div>
                  </div>
                ` : ''}

<!-- âœ… (B) ì—¬ê¸°! ì¹´ë“œ ì•ˆ ë²„íŠ¼ 3ê°œ ì‚½ì… -->
              <div class="segmented">
  <button type="button" class="seg-btn" onclick="copyVehicleInfo('${vehicle.id}')">ğŸ“‹ ë³µì‚¬</button>
  <button type="button" class="seg-btn primary" onclick="editVehicle('${vehicle.id}')">âœï¸ ìˆ˜ì •</button>
  <button type="button" class="seg-btn danger" onclick="deleteVehicle('${vehicle.id}', '${escapeHTML(vehicle.vehicleNumber || '')}')">ğŸ—‘ï¸ ì‚­ì œ</button>
</div>



              </div>
            </article>

         
          </div>
        `;
      }).join('');

      updateBadges();
    }

    function toggleVehicleMenu(vehicleId){
      const menu = document.getElementById(`vehicle-menu-${vehicleId}`);
      if(!menu) return;

      // ë‹¤ë¥¸ ë©”ë‰´ ë‹«ê¸°
      document.querySelectorAll('[id^="vehicle-menu-"]').forEach(m => m.style.display='none');

      const open = (menu.style.display === 'flex');
      if(!open) menu.style.display = 'flex';
      else menu.style.display = 'none';
    }

    function copyVehicleInfo(vehicleId){
      const v = vehicles.find(x => x.id === vehicleId);
      if(!v){ toast('ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      const maintDate = v.maintenanceDate ? new Date(v.maintenanceDate.toDate()).toLocaleDateString('ko-KR') : '';
      const nextDate = v.nextMaintenanceDate ? new Date(v.nextMaintenanceDate.toDate()).toLocaleDateString('ko-KR') : '';

      const text =
`[MSL ì°¨ëŸ‰ ì •ë¹„ì •ë³´]
ì°¨ëŸ‰ë²ˆí˜¸: ${v.vehicleNumber || ''}
ì°¨ëŸ‰ëª…: ${v.vehicleName || ''}
ìµœê·¼ì •ë¹„: ${v.lastMaintenance || ''}
ì •ë¹„ì¼: ${maintDate}
ë‹¤ìŒì •ë¹„: ${nextDate}
`;

      if(navigator.clipboard){
        navigator.clipboard.writeText(text).then(()=>toast('ğŸ“‹ ì°¨ëŸ‰ ì •ë³´ ë³µì‚¬ ì™„ë£Œ'));
      }else{
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ğŸ“‹ ì°¨ëŸ‰ ì •ë³´ ë³µì‚¬ ì™„ë£Œ');
      }
      toggleVehicleMenu(vehicleId);
    }

    function editVehicle(vehicleId){
      const v = vehicles.find(x => x.id === vehicleId);
      if(!v){ toast('ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      // ê´€ë¦¬íƒ­ìœ¼ë¡œ ì´ë™í•´ì„œ í¼ ì±„ìš°ê¸°
      editingVehicleId = vehicleId;

      // íƒ­ ì „í™˜
      document.querySelector('.tab[data-tab="admin"]').click();

      setTimeout(() => {
        const num = document.getElementById('vehicleNumber');
        const name = document.getElementById('vehicleName');
        const maint = document.getElementById('vehicleMaintenance');
        const mDate = document.getElementById('maintenanceDate');
        const nDate = document.getElementById('nextMaintenanceDate');

        if(num) num.value = v.vehicleNumber || '';
        if(name) name.value = v.vehicleName || '';
        if(maint) maint.value = v.lastMaintenance || '';
        if(mDate) mDate.value = v.maintenanceDate ? toDateInputValue(v.maintenanceDate.toDate()) : '';
        if(nDate) nDate.value = v.nextMaintenanceDate ? toDateInputValue(v.nextMaintenanceDate.toDate()) : '';

        toast('âœï¸ ì°¨ëŸ‰ ìˆ˜ì • ëª¨ë“œ');
      }, 250);

      toggleVehicleMenu(vehicleId);
    }

    async function deleteVehicle(vehicleId, vehicleNumber){
      if(!confirm(`"${vehicleNumber}" ì°¨ëŸ‰ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
        toggleVehicleMenu(vehicleId);
        return;
      }

      try{
        await db.collection('vehicles').doc(vehicleId).delete();
        toast('ğŸ—‘ï¸ ì°¨ëŸ‰ ì‚­ì œ ì™„ë£Œ');
        await loadVehiclesFromFirebase();
        loadVehicles();

        if(isAdmin){
          // ê´€ë¦¬íƒ­ì˜ ë°°ì§€ë„ ê°±ì‹ 
          loadManageData();
        }
      }catch(err){
        console.error('ì°¨ëŸ‰ ì‚­ì œ ì˜¤ë¥˜:', err);
        toast('âŒ ì°¨ëŸ‰ ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function clearVehicleForm(){
      editingVehicleId = null;
      document.getElementById('vehicleNumber').value = '';
      document.getElementById('vehicleName').value = '';
      document.getElementById('vehicleMaintenance').value = '';
      document.getElementById('maintenanceDate').value = '';
      document.getElementById('nextMaintenanceDate').value = '';
      toast('ğŸš— ì°¨ëŸ‰ í¼ ì´ˆê¸°í™”');
    }

    async function submitVehicle(btn){
      const vehicleNumber = document.getElementById('vehicleNumber').value.trim();
      const vehicleName = document.getElementById('vehicleName').value.trim();
      const lastMaintenance = document.getElementById('vehicleMaintenance').value.trim();
      const maintenanceDate = document.getElementById('maintenanceDate').value;
      const nextMaintenanceDate = document.getElementById('nextMaintenanceDate').value;

      if(!vehicleNumber){
        toast('âš ï¸ ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const payload = {
        vehicleNumber,
        vehicleName: vehicleName || '',
        lastMaintenance: lastMaintenance || '',
        maintenanceDate: maintenanceDate ? tsFromDateInput(maintenanceDate) : null,
        nextMaintenanceDate: nextMaintenanceDate ? tsFromDateInput(nextMaintenanceDate) : null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      const original = btn?.textContent || '';
      if(btn){
        btn.textContent = 'ì €ì¥ ì¤‘...';
        btn.disabled = true;
      }

      try{
        if(editingVehicleId){
          await db.collection('vehicles').doc(editingVehicleId).update(payload);
          toast('âœ… ì°¨ëŸ‰ ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
        }else{
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('vehicles').add(payload);
          toast('âœ… ì°¨ëŸ‰ ë“±ë¡ ì™„ë£Œ');
        }

        clearVehicleForm();
        await loadVehiclesFromFirebase();
        updateBadges();

        // ì°¨ëŸ‰íƒ­ ë°˜ì˜
        const currentTab = document.querySelector('.tab.active')?.dataset.tab;
        if(currentTab === 'vehicle') loadVehicles();
        if(currentTab === 'admin') loadManageData();

      }catch(err){
        console.error('ì°¨ëŸ‰ ì €ì¥ ì˜¤ë¥˜:', err);
        toast('âŒ ì°¨ëŸ‰ ì €ì¥ ì‹¤íŒ¨');
      }finally{
        if(btn){
          btn.textContent = original || 'ğŸš— ë“±ë¡/ìˆ˜ì •';
          btn.disabled = false;
        }
      }
    }

    // =========================
    // ì•„ì°¨ì‚¬ê³  ìƒíƒœ ì •ë³´
    // =========================
    function getNearmissStatusInfo(status) {
      const statusMap = {
        'pending': { text: 'ëŒ€ê¸°', class: 'blue' },
        'reviewing': { text: 'ê²€í† ì¤‘', class: 'orange' },
        'completed': { text: 'ì™„ë£Œ', class: 'green' },
        'rejected': { text: 'ë°˜ë ¤', class: 'red' }
      };
      return statusMap[status] || statusMap['pending'];
    }

    async function viewNearmissDetail(id) {
      try {
        const doc = await db.collection('nearmiss').doc(id).get();
        if (!doc.exists) {
          toast('âŒ ì œì•ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }

        const item = { id: doc.id, ...doc.data() };
        const statusInfo = getNearmissStatusInfo(item.status || 'pending');
        const createdAt = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString('ko-KR') : 'ë°©ê¸ˆ';

        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.display = 'flex';

        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
              <h3>ğŸ’¡ ì œì•ˆ ìƒì„¸</h3>
              <button class="icon-btn" onclick="this.closest('.modal').remove()" style="box-shadow:none; width:36px; height:36px;">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; border-radius: 12px; background: linear-gradient(135deg, rgba(43,107,255,.08), rgba(78,208,255,.06));">
                <div style="font-size: 14px; font-weight: 800; color: var(--text);">${escapeHTML(item.submitterName || 'ìµëª…')}</div>
                <div class="status-chip ${statusInfo.class}">${statusInfo.text}</div>
              </div>

              ${item.imageUrl ? `
                <div style="margin-bottom: 16px;">
                  <div class="label" style="margin-bottom: 8px;">ğŸ“· ì²¨ë¶€ ì´ë¯¸ì§€</div>
                  <img src="${escapeHTML(item.imageUrl)}" style="width: 100%; border-radius: 16px; border: 1px solid var(--stroke);" onclick="window.open('${escapeHTML(item.imageUrl)}', '_blank')">
                </div>
              ` : ''}

              <div style="margin-bottom: 16px;">
                <div class="label" style="margin-bottom: 8px;">ğŸ“ ì œì•ˆ ë‚´ìš©</div>
                <div style="padding: 14px; border-radius: 12px; border: 1px solid var(--stroke); background: var(--surface); font-size: 13px; color: var(--text); line-height: 1.6; white-space: pre-wrap;">${escapeHTML(item.content || 'ë‚´ìš© ì—†ìŒ')}</div>
              </div>

              <div style="font-size: 11px; color: var(--muted); font-weight: 600;">
                ğŸ“… ì œì¶œì¼ì‹œ: ${createdAt}
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      } catch (error) {
        console.error('ìƒì„¸ë³´ê¸° ì˜¤ë¥˜:', error);
        toast('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    }

    async function changeNearmissStatus(id) {
      const statusOptions = [
        { value: 'pending', label: 'ëŒ€ê¸°', class: 'blue' },
        { value: 'reviewing', label: 'ê²€í† ì¤‘', class: 'orange' },
        { value: 'completed', label: 'ì™„ë£Œ', class: 'green' },
        { value: 'rejected', label: 'ë°˜ë ¤', class: 'red' }
      ];

      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
          <div class="modal-header">
            <h3>ğŸ”„ ìƒíƒœ ë³€ê²½</h3>
            <button class="icon-btn" onclick="this.closest('.modal').remove()" style="box-shadow:none; width:36px; height:36px;">
              <svg class="icon" viewBox="0 0 24 24" fill="none">
                <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div style="display: grid; gap: 10px;">
              ${statusOptions.map(opt => `
                <button class="status-option" onclick="updateNearmissStatus('${id}', '${opt.value}', this)" style="padding: 14px; border-radius: 12px; border: 2px solid var(--stroke); background: var(--surface); cursor: pointer; transition: all .2s ease; display: flex; align-items: center; gap: 10px;">
                  <div class="status-chip ${opt.class}" style="margin: 0;">${opt.label}</div>
                  <div style="flex: 1; text-align: left; font-size: 13px; font-weight: 700; color: var(--text);">${opt.label}ë¡œ ë³€ê²½</div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function updateNearmissStatus(id, status, btn) {
      btn.textContent = 'ë³€ê²½ ì¤‘...';
      btn.disabled = true;

      try {
        await db.collection('nearmiss').doc(id).update({
          status: status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        toast('âœ… ìƒíƒœ ë³€ê²½ ì™„ë£Œ');
        document.querySelectorAll('.modal').forEach(m => m.remove());
        loadManageData();
      } catch (error) {
        console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
        toast('âŒ ë³€ê²½ ì‹¤íŒ¨');
        btn.disabled = false;
      }
    }

    // =========================
    // Admin íƒ­ (ê´€ë¦¬ì ë„êµ¬)
    // =========================
    async function loadManageData() {
      const container = document.getElementById('adminGrid');

      if (!isAdmin) {
        container.innerHTML = `
          <div class="empty">
            <div class="mail">ğŸ”’</div>
            <div>
              <b>ê´€ë¦¬ì ê¶Œí•œ í•„ìš”</b>
              <span>ìƒë‹¨ âš™ï¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê´€ë¦¬ì ë¡œê·¸ì¸ í•˜ì„¸ìš”.</span>
            </div>
          </div>
        `;
        return;
      }

      await loadDocumentsFromFirebase();
      await loadSignaturesFromFirebase();
      await loadVehiclesFromFirebase();

      let nearmissSuggestions = [];
      try {
        const snapshot = await db.collection('nearmiss').orderBy('createdAt', 'desc').limit(20).get();
        nearmissSuggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('ì•„ì°¨ì‚¬ê³  ë¡œë“œ ì˜¤ë¥˜:', error);
      }

      container.innerHTML = `
        <!-- ì°¨ëŸ‰ ë“±ë¡/ê´€ë¦¬ ì¹´ë“œ -->
        <article class="card">
          <div class="card-head">
            <div class="left">
              <div class="emoji">ğŸš—</div>
              <div class="title">
                <b>ì‚¬ë‚´ì°¨ëŸ‰ ì •ë¹„ë‚´ì—­ ë“±ë¡</b>
                <span>ì°¨ëŸ‰ ì¶”ê°€ ë° ì •ë¹„ë‚´ì—­ ê¸°ë¡</span>
              </div>
            </div>
            <div class="status-chip green">ì°¨ëŸ‰</div>
          </div>
          <div class="card-body">
            <div class="field">
              <div class="label">ì°¨ëŸ‰ë²ˆí˜¸</div>
              <input type="text" id="vehicleNumber" class="input" placeholder="ì˜ˆ) 12ê°€ 3456">
            </div>
            <div class="field">
              <div class="label">ì°¨ëŸ‰ëª… (ì„ íƒ)</div>
              <input type="text" id="vehicleName" class="input" placeholder="ì˜ˆ) ì†Œë‚˜íƒ€, í¬í„° ë“±">
            </div>
            <div class="field">
              <div class="label">ì •ë¹„ë‚´ì—­</div>
              <textarea id="vehicleMaintenance" class="textarea" placeholder="ì •ë¹„ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="field">
              <div class="label">ì •ë¹„ì¼ì</div>
              <input type="date" id="maintenanceDate" class="input">
            </div>
            <div class="field">
              <div class="label">ë‹¤ìŒ ì •ë¹„ ì˜ˆì •ì¼ (ì„ íƒ)</div>
              <input type="date" id="nextMaintenanceDate" class="input">
            </div>

            <div class="cta">
              <button class="btn ghost" onclick="clearVehicleForm()">ì´ˆê¸°í™”</button>
              <button class="btn primary" onclick="submitVehicle(this)">ğŸš— ë“±ë¡/ìˆ˜ì •</button>
            </div>
          </div>
        </article>

        <!-- ë¬¸ì„œ ë“±ë¡ ì¹´ë“œ -->
        <article class="card">
          <div class="card-head">
            <div class="left">
              <div class="emoji">ğŸ“</div>
              <div class="title">
                <b>ì•ˆì „ë³´ê±´ íšŒëŒìë£Œ ë“±ë¡</b>
                <span>ìƒˆ ë¬¸ì„œ ì‘ì„± ë° ë°°í¬</span>
              </div>
            </div>
            <div class="status-chip orange">ë“±ë¡</div>
          </div>
          <div class="card-body">
            <div class="field">
              <div class="label">ì œëª©</div>
              <input type="text" id="docTitle" class="input" placeholder="ì˜ˆ) 1ì›” 1ì£¼ì°¨ ì•ˆì „ë³´ê±´ íšŒëŒ">
            </div>
            <div class="field">
              <div class="label">ë‚´ìš©</div>
              <textarea id="docContent" class="textarea" placeholder="íšŒëŒí•  ì•ˆì „ë³´ê±´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="field">
              <div class="label">ì²¨ë¶€íŒŒì¼ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê³µìœ  ë§í¬)</div>
              <input type="text" id="docAttachment" class="input" placeholder="https://drive.google.com/file/d/...">
              <div style="font-size:11px; color:var(--muted); margin-top:4px; font-weight:600;">
                ğŸ’¡ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ íŒŒì¼ ì—…ë¡œë“œ â†’ ê³µìœ  â†’ ë§í¬ ë³µì‚¬ â†’ ë¶™ì—¬ë„£ê¸°
              </div>
            </div>

            <div class="cta">
              <button class="btn ghost" onclick="clearDocForm()">ì´ˆê¸°í™”</button>
              <button class="btn primary" onclick="submitDocument(this)">ğŸ“¤ ë¬¸ì„œ ë“±ë¡</button>
            </div>
          </div>
        </article>

        <!-- ì•„ì°¨ì‚¬ê³  ì œì•ˆ ë‚´ì—­ ì¹´ë“œ -->
        <article class="card">
          <div class="card-head">
            <div class="left">
              <div class="emoji">ğŸ’¡</div>
              <div class="title">
                <b>ì•„ì°¨ì‚¬ê³  Â· ê°œì„ ì‚¬í•­ ì œì•ˆ ë‚´ì—­</b>
                <span>ì´ ${nearmissSuggestions.length}ê±´</span>
              </div>
            </div>
            <div class="status-chip blue">ê´€ë¦¬</div>
          </div>
          <div class="card-body">
            ${nearmissSuggestions.length === 0 ? `
              <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“­</div>
                <div style="font-size: 13px; font-weight: 700;">ì œì•ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
              </div>
            ` : `
              <div class="nearmiss-list">
                ${nearmissSuggestions.map(item => {
                  const statusInfo = getNearmissStatusInfo(item.status || 'pending');
                  const createdAt = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString('ko-KR', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  }) : 'ë°©ê¸ˆ';

                  return `
                    <div class="nearmiss-item">
                      <div style="display: flex; gap: 12px; margin-bottom: 10px;">
                        ${item.imageUrl ? `
                          <img src="${escapeHTML(item.imageUrl)}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px; border: 1px solid var(--stroke); flex-shrink: 0;" onclick="window.open('${escapeHTML(item.imageUrl)}', '_blank')">
                        ` : `
                          <div style="width: 80px; height: 80px; border-radius: 12px; border: 1px solid var(--stroke); background: linear-gradient(135deg, rgba(43,107,255,.08), rgba(78,208,255,.06)); display: grid; place-items: center; font-size: 32px; flex-shrink: 0;">ğŸ“·</div>
                        `}
                        <div style="flex: 1; min-width: 0;">
                          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 800; color: var(--text);">${escapeHTML(item.submitterName || 'ìµëª…')}</div>
                            <div class="status-chip ${statusInfo.class}" style="padding: 4px 8px; font-size: 10px;">${statusInfo.text}</div>
                          </div>
                          <div style="font-size: 12px; color: var(--text); line-height: 1.5; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHTML(item.content || 'ë‚´ìš© ì—†ìŒ')}</div>
                          <div style="font-size: 11px; color: var(--muted); font-weight: 600;">ğŸ“… ${createdAt}</div>
                        </div>
                      </div>
                      <div style="display: flex; gap: 6px;">
                        <button class="btn ghost" onclick="viewNearmissDetail('${item.id}')" style="flex: 1; padding: 8px;">ìƒì„¸ë³´ê¸°</button>
                        <button class="btn primary" onclick="changeNearmissStatus('${item.id}')" style="flex: 1; padding: 8px;">ìƒíƒœë³€ê²½</button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </article>

        <!-- ë°°í¬ëœ ìë£Œ ëª©ë¡ ì¹´ë“œ -->
        <article class="card">
          <div class="card-head">
            <div class="left">
              <div class="emoji">ğŸ“‹</div>
              <div class="title">
                <b>ë°°í¬ëœ ìë£Œ ëª©ë¡</b>
                <span>ì´ ${documents.length}ê±´</span>
              </div>
            </div>
            <div class="status-chip blue">ì¡°íšŒ</div>
          </div>
          <div class="card-body">
            <div style="padding: 16px; border-radius: 12px; border: 1px solid var(--stroke); background: var(--surface-2); margin-bottom: 16px;">
              <div style="font-size: 14px; font-weight: 800; color: var(--primary); margin-bottom: 12px;">ë°°í¬ëœ ìë£Œ ëª©ë¡</div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div class="field" style="margin-bottom: 0;">
                  <div class="label" style="margin-bottom: 6px;">ì‹œì‘ì¼</div>
                  <input type="date" id="filterStartDate" class="input" style="padding: 10px;">
                </div>
                <div class="field" style="margin-bottom: 0;">
                  <div class="label" style="margin-bottom: 6px;">ì¢…ë£Œì¼</div>
                  <input type="date" id="filterEndDate" class="input" style="padding: 10px;">
                </div>
              </div>

              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="btn ghost" onclick="setFilterDate('today')" style="flex: 1; padding: 8px; font-size: 12px;">ì˜¤ëŠ˜</button>
                <button class="btn ghost" onclick="setFilterDate('week')" style="flex: 1; padding: 8px; font-size: 12px;">ì´ë²ˆ ì£¼</button>
                <button class="btn ghost" onclick="setFilterDate('month')" style="flex: 1; padding: 8px; font-size: 12px;">ì´ë²ˆ ë‹¬</button>
                <button class="btn ghost" onclick="setFilterDate('all')" style="flex: 1; padding: 8px; font-size: 12px;">ì „ì²´</button>
              </div>

              <button class="btn primary" onclick="applyDocumentFilter()" style="width: 100%;">ì ìš©</button>
            </div>

            <div id="filteredDocsList"></div>
          </div>
        </article>

        <!-- í†µê³„ ì¹´ë“œ -->
        <article class="card">
          <div class="card-head">
            <div class="left">
              <div class="emoji">ğŸ“Š</div>
              <div class="title">
                <b>ì£¼ê°„ í†µê³„ ìš”ì•½</b>
                <span>ì½ìŒ/ì„œëª…/ì œì•ˆ í˜„í™©</span>
              </div>
            </div>
            <div class="status-chip blue">ë¦¬í¬íŠ¸</div>
          </div>
          <div class="card-body">
            <div class="stats">
              <div class="stat green">
                <b>ì´ ë¬¸ì„œ</b>
                <div class="value"><strong>${documents.length}</strong><span>ê±´</span></div>
              </div>
              <div class="stat">
                <b>ì´ ì„œëª…</b>
                <div class="value"><strong>${signatures.length}</strong><span>ê±´</span></div>
              </div>
              <div class="stat orange">
                <b>ì œì•ˆ</b>
                <div class="value"><strong>${nearmissSuggestions.length}</strong><span>ê±´</span></div>
              </div>
              <div class="stat">
                <b>ì°¨ëŸ‰</b>
                <div class="value"><strong>${vehicles.length}</strong><span>ëŒ€</span></div>
              </div>
            </div>

            <div class="cta">
              <button class="btn ghost" onclick="toast('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° í™•ì¥ ê°€ëŠ¥')">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
              <button class="btn ghost" onclick="toast('ì „ì²´ ë¬¸ì„œ ë³´ê¸° í™•ì¥ ê°€ëŠ¥')">ì „ì²´ ë¬¸ì„œ ë³´ê¸°</button>
            </div>
          </div>
        </article>
      `;

      setTimeout(() => displayFilteredDocuments(documents), 0);
      updateBadges();
    }

    // ë¬¸ì„œ ë“±ë¡
    function clearDocForm() {
      document.getElementById('docTitle').value = '';
      document.getElementById('docContent').value = '';
      document.getElementById('docAttachment').value = '';
      toast('ğŸ“ í¼ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    async function submitDocument(btn) {
      const title = document.getElementById('docTitle').value.trim();
      const content = document.getElementById('docContent').value.trim();
      const attachmentUrl = document.getElementById('docAttachment').value.trim();

      if (!title) {
        toast('âš ï¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      if (!content && !attachmentUrl) {
        toast('âš ï¸ ë‚´ìš© ë˜ëŠ” ì²¨ë¶€íŒŒì¼ ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤');
        return;
      }

      if (attachmentUrl && !attachmentUrl.includes('drive.google.com')) {
        if (!confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬ê°€ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      const originalText = btn?.textContent || '';
      if(btn){
        btn.textContent = 'ë“±ë¡ ì¤‘...';
        btn.disabled = true;
      }

      try {
        const docData = {
          title: title,
          content: content,
          attachmentUrl: attachmentUrl || '',
          tbmItems: FIXED_TBM_ITEMS,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: 'admin'
        };

        await db.collection('documents').add(docData);

        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
          colors: ['#2B6BFF', '#4ED0FF', '#12B76A']
        });

        toast('âœ… ë¬¸ì„œ ë“±ë¡ ì™„ë£Œ!');
        clearDocForm();

        await loadDocumentsFromFirebase();
        updateBadges();
        displayFilteredDocuments(documents);

      } catch (error) {
        console.error('ë¬¸ì„œ ë“±ë¡ ì˜¤ë¥˜:', error);
        toast('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
      } finally {
        if(btn){
          btn.textContent = originalText || 'ğŸ“¤ ë¬¸ì„œ ë“±ë¡';
          btn.disabled = false;
        }
      }
    }

    // ë‚ ì§œ í•„í„°
    function setFilterDate(period) {
      const today = new Date();
      const startInput = document.getElementById('filterStartDate');
      const endInput = document.getElementById('filterEndDate');

      endInput.valueAsDate = today;

      switch(period) {
        case 'today':
          startInput.valueAsDate = today;
          break;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(today.getDate() - 7);
          startInput.valueAsDate = weekAgo;
          break;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setMonth(today.getMonth() - 1);
          startInput.valueAsDate = monthAgo;
          break;
        case 'all':
          startInput.value = '';
          endInput.value = '';
          break;
      }
    }

    function applyDocumentFilter() {
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;

      let filteredDocs = documents;

      if (startDate || endDate) {
        filteredDocs = documents.filter(doc => {
          if (!doc.createdAt) return false;

          const docDate = doc.createdAt.toDate();
          docDate.setHours(0, 0, 0, 0);

          if (startDate) {
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            if (docDate < start) return false;
          }

          if (endDate) {
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            if (docDate > end) return false;
          }

          return true;
        });
      }

      displayFilteredDocuments(filteredDocs);
      toast(`ğŸ“‹ ${filteredDocs.length}ê±´ì˜ ë¬¸ì„œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤`);
    }

    function displayFilteredDocuments(docs) {
      const container = document.getElementById('filteredDocsList');
      if (!container) return;

      if (docs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“­</div>
            <div style="font-size: 13px; font-weight: 700;">í•´ë‹¹ ê¸°ê°„ì— ë°°í¬ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      const grouped = {};
      docs.forEach(doc => {
        if (!doc.createdAt) return;
        const date = doc.createdAt.toDate();
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(doc);
      });

      const sortedDates = Object.keys(grouped).sort().reverse();

      let html = '';
      sortedDates.forEach(dateKey => {
        const [year, month, day] = dateKey.split('-');
        const dateLabel = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
        const dateDocs = grouped[dateKey];

        html += `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; font-weight: 800; color: var(--muted); margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
              ğŸ“… ${dateLabel}
            </div>
        `;

        dateDocs.forEach(doc => {
          const docSigs = signatures.filter(s => s.documentId === doc.id);
          const completionRate = Math.round((docSigs.length / employees.length) * 100);

          let statusClass = 'red';
          let statusText = 'ë¯¸í¡';
          if (completionRate >= 90) { statusClass = 'green'; statusText = 'ìš°ìˆ˜'; }
          else if (completionRate >= 60) { statusClass = 'orange'; statusText = 'ë³´í†µ'; }

          const docId = doc.id;
          const safeTitle = escapeHTML(doc.title || '');
html += `
  <div style="position: relative; margin-bottom: 8px;">
    <div style="padding: 14px; border-radius: 14px; border: 1px solid var(--stroke); background: var(--surface);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, rgba(43,107,255,.12), rgba(78,208,255,.08)); display: grid; place-items: center; font-size: 20px; flex-shrink: 0;">ğŸ“„</div>

        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 14px; font-weight: 800; color: var(--text); margin-bottom: 4px;">${safeTitle}</div>
          <div style="font-size: 11px; color: var(--muted); font-weight: 600;">
            í™•ì¸ë¥  ${docSigs.length}/${employees.length} (${completionRate}%)
          </div>

          <!-- âœ… ì—¬ê¸°: í™•ì¸ë¥  ë°”ë¡œ ì•„ë˜ 5ê°œ ë²„íŠ¼ -->
          <div class="doc-actions">
            <button type="button" class="actionBtn" onclick="copyDocLink('${docId}')">ğŸ”— ë§í¬ ë³µì‚¬</button>
            <button type="button" class="actionBtn" onclick="showSignatureStatus('${docId}')">âœ… í™•ì¸ í˜„í™©</button>
            <button type="button" class="actionBtn" onclick="downloadExcelReport('${docId}')">ğŸ“Š ì—‘ì…€ ë³´ê³ ì„œ</button>
            <button type="button" class="actionBtn" onclick="editDocument('${docId}')">âœï¸ ìˆ˜ì •</button>
            <button type="button" class="actionBtn danger" onclick="deleteDocument('${docId}', '${safeTitle.replaceAll("&#39;","\\'")}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>

        <div class="status-chip ${statusClass}">${statusText}</div>
      </div>
    </div>
  </div>
`;

        });

        html += `</div>`;
      });

      container.innerHTML = html;
    }

    // =========================
    // ë‚ ì§œì¹© ì—…ë°ì´íŠ¸
    // =========================
    function updateDateChip(){
    const now = new Date();
    const label = now.toLocaleDateString('ko-KR', { month:'numeric', day:'numeric' });
    const chip = document.getElementById('dateChip');
    if(chip) chip.textContent = `${label}`;
  }

  // =========================
  // URL íŒŒë¼ë¯¸í„° doc ì²˜ë¦¬
  // =========================
  async function handleDocParam(){
    const params = new URLSearchParams(location.search);
    const docId = params.get('doc');
    if(!docId) return;

    await loadDocumentsFromFirebase();
    await loadSignaturesFromFirebase();

    const userName = localStorage.getItem('mslUserName');
    if(!userName){
      showNameInputModal();   // âœ… ì—¬ê¸°! ... ì´ ì•„ë‹ˆë¼ () ë¡œ í˜¸ì¶œ
      return;
    }

    const doc = documents.find(d => d.id === docId);
    if(!doc){
      toast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }

    // ë°”ë¡œ ì„œëª… ëª¨ë‹¬ ì—´ê¸°
    openSignatureModal(docId);
  }

  

  // =========================
  // ìµœì´ˆ ì‹¤í–‰(ì´ˆê¸° ë¡œë”©)
  // =========================
  window.addEventListener('DOMContentLoaded', async () => {
    updateDateChip();
     updateUserNamePill();

    // ë°ì´í„° ë¨¼ì € ë¡œë“œ â†’ ë°°ì§€/ëª©ë¡ ì•ˆì •í™”
    await loadDocumentsFromFirebase();
    await loadSignaturesFromFirebase();
    await loadVehiclesFromFirebase();

    updateBadges();
    loadPendingDocuments();  // ê¸°ë³¸ í™”ë©´: ì„œëª…í™•ì¸ íƒ­

    handleDocParam();        // ?doc=xxx ë¡œ ë“¤ì–´ì˜¤ë©´ ë°”ë¡œ ì—´ê¸°
  });

    // =========================
// âœ… êµìœ¡ ë¬¸ì„œ íŒë³„ ê¸°ì¤€
// =========================
function isEducationDoc(doc){
  const title = String(doc?.title ?? '');
  const type  = String(doc?.type ?? doc?.category ?? doc?.docType ?? doc?.kind ?? '');
  const tag   = String(doc?.tag ?? doc?.tags ?? '');
  const flag  = doc?.isEducation === true || doc?.education === true;

  const hay = (title + ' ' + type + ' ' + tag).toLowerCase();

  // âœ… í”„ë¡œì íŠ¸ì—ì„œ ì‹¤ì œë¡œ ì“°ëŠ” ê°’ì— ë§ì¶° í‚¤ì›Œë“œ ì¶”ê°€ ê°€ëŠ¥
  return flag
    || hay.includes('êµìœ¡')
    || hay.includes('ì•ˆì „ë³´ê±´êµìœ¡')
    || hay.includes('ë²•ì •êµìœ¡')
    || hay.includes('health')
    || hay.includes('education');
}



/***********************
 * âœ… ë‚´ì •ë³´(ë‹¨ì¼/ì•ˆì •) ëª¨ë‹¬
 * ì „ì œ:
 *  - ì „ì—­ ë°°ì—´ documents = [] , signatures = [] ê°€ ì¡´ì¬ (Firebase ë¡œë“œ)
 *  - localStorageì— mslUserName, mslUserDept ì €ì¥(ì—†ì–´ë„ ë™ì‘)
 ************************/


// âœ… [4ë²ˆ] ë‚´ì •ë³´ ì—´ê¸°: (ë‹¨ì¼) ë°ì´í„° ìµœì‹ í™” í›„ mi ëª¨ë‹¬ ì˜¤í”ˆ  <-- ì—¬ê¸° ì¶”ê°€// =========================
// âœ… ë‚´ì •ë³´(ë‹¨ì¼/ì•ˆì •) ëª¨ë‹¬ êµ¬í˜„
// =========================
const miOverlay = document.getElementById('myInfoModal');
const miBody    = document.getElementById('myInfoBody');
const miCloseBtn= document.getElementById('myInfoCloseBtn');

function openMyInfoModal(){
  if(!miOverlay) return;
  miOverlay.classList.add('is-open');
}
function closeMyInfoModal(){
  if(!miOverlay) return;
  miOverlay.classList.remove('is-open');
}

// ë‹«ê¸° ë²„íŠ¼
if(miCloseBtn){
  miCloseBtn.addEventListener('click', closeMyInfoModal);
}

// ì˜¤ë²„ë ˆì´ ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
if(miOverlay){
  miOverlay.addEventListener('click', (e) => {
    if(e.target === miOverlay) closeMyInfoModal();
  });
}

// ESC ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && miOverlay?.classList.contains('is-open')) closeMyInfoModal();
});

function formatTS(ts){
  if(!ts) return '-';
  try{
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString('ko-KR', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
  }catch(e){
    return '-';
  }
}

function isSameDay(a, b){
  const da = new Date(a); da.setHours(0,0,0,0);
  const db = new Date(b); db.setHours(0,0,0,0);
  return da.getTime() === db.getTime();
}

// âœ… async ì¶”ê°€!
async function computeMyStats(userName){
  const mySigs = signatures
    .filter(s => s.signerName === userName)
    .slice()
    .sort((a,b) => (b.signedAt?.toMillis?.() ?? 0) - (a.signedAt?.toMillis?.() ?? 0));

  const pendingDocs = documents.filter(doc => {
    return !signatures.some(s => s.documentId === doc.id && s.signerName === userName);
  });

  const eduPending = pendingDocs.filter(d => isEducationDoc(d));

  const lastSignedAt = mySigs[0]?.signedAt ? formatTS(mySigs[0].signedAt) : '-';

  const today = new Date();
  const todaySigned = mySigs.filter(s => {
    const d = s.signedAt?.toDate ? s.signedAt.toDate() : null;
    return d ? isSameDay(d, today) : false;
  }).length;

  // âœ… ì•„ì°¨ì‚¬ê³  ì œì•ˆ ê±´ìˆ˜ ì¡°íšŒ (ì¶”ê°€!)
  let myNearmissCount = 0;
  try {
    const nearmissSnapshot = await db.collection('nearmiss')
      .where('submitterName', '==', userName)
      .get();
    
    if (nearmissSnapshot && nearmissSnapshot.docs) {
      myNearmissCount = nearmissSnapshot.docs.length;
      console.log(`âœ… ${userName}ë‹˜ì˜ ì•„ì°¨ì‚¬ê³  ì œì•ˆ: ${myNearmissCount}ê±´`);
    }
  } catch (error) {
    console.error('âŒ ì•„ì°¨ì‚¬ê³  ì¡°íšŒ ì˜¤ë¥˜:', error);
    myNearmissCount = 0;
  }

  // ì°¨ëŸ‰ ì•Œë¦¼(ì§€ì—°/ì„ë°•)
  const vehicleAlerts = (vehicles || []).map(v => {
    const st = getVehicleStatus(v);
    return { v, st };
  }).filter(x => x.st.class === 'red' || x.st.class === 'orange');

  return {
    mySigs,
    pendingDocs,
    eduPending,
    lastSignedAt,
    todaySigned,
    myNearmissCount,  // âœ… ì¶”ê°€!
    vehicleAlerts
  };
}

async function renderMyInfoHTML(userName, userDept){
  const stats = await computeMyStats(userName);

  const pendingTop = stats.pendingDocs
    .slice()
    .sort((a,b) => (b.createdAt?.toMillis?.() ?? 0) - (a.createdAt?.toMillis?.() ?? 0))
    

  const recentSigned = stats.mySigs.slice(0, 5);

  const vehicleTop = stats.vehicleAlerts.slice(0, 3);

  // ìƒíƒœ ë°°ì§€
  const badgeHTML = (text, cls) => `
    <span class="mi-badge ${cls}">${text}</span>
  `;

// âœ… 1. ë¯¸ì„œëª… ë°°ì§€
const pendingBadge =
  stats.pendingDocs.length === 0 ? badgeHTML('ë¯¸ì„œëª… 0 Â· ì™„ë²½', 'ok')
  : stats.pendingDocs.length <= 2 ? badgeHTML(`ë¯¸ì„œëª… ${stats.pendingDocs.length}`, 'warn')
  : badgeHTML(`ë¯¸ì„œëª… ${stats.pendingDocs.length}`, 'neutral');

// âœ… 2. ì•„ì°¨ì‚¬ê³  ì œì•ˆ ë°°ì§€ (ìƒˆë¡œ ì¶”ê°€)
const nearmissBadge =
  stats.myNearmissCount === 0 ? badgeHTML('ì•„ì°¨ì‚¬ê³  ì œì•ˆ 0ê±´', 'neutral')
  : stats.myNearmissCount >= 5 ? badgeHTML(`ì•„ì°¨ì‚¬ê³  ì œì•ˆ ${stats.myNearmissCount}ê±´ Â· ìš°ìˆ˜`, 'ok')
  : badgeHTML(`ì•„ì°¨ì‚¬ê³  ì œì•ˆ ${stats.myNearmissCount}ê±´`, 'ok');

// âœ… 3. ì°¨ëŸ‰ ì•Œë¦¼ ë°°ì§€
const vehicleBadge =
  vehicleTop.length === 0 ? badgeHTML('ì°¨ëŸ‰ ì•Œë¦¼ ì—†ìŒ', 'ok')
  : badgeHTML(`ì°¨ëŸ‰ ì•Œë¦¼ ${vehicleTop.length}`, 'warn');

return `
  <div class="mi-card">
    <div class="mi-row" style="align-items:flex-start;">
      <div style="flex:1; min-width:0;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
          <div style="width:44px; height:44px; border-radius:14px; background: linear-gradient(135deg, var(--primary), var(--primary-2)); display:grid; place-items:center; color:#fff; font-weight:900;">
            ${(userName||'').trim().charAt(0) || 'M'}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:900; font-size:16px; letter-spacing:-.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${escapeHTML(userName || 'ì´ë¦„ ì—†ìŒ')}
            </div>
            <div style="margin-top:4px; font-size:12px; color:var(--muted); font-weight:700;">
              ${escapeHTML(userDept || 'ë¶€ì„œ ë¯¸ì„¤ì •')}
            </div>
          </div>
        </div>

        <!-- âœ… ë°°ì§€ 3ê°œë§Œ í‘œì‹œ -->
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          ${pendingBadge}
          ${nearmissBadge}
          ${vehicleBadge}
        </div>

                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--stroke);">
          <div style="font-size:12px; color:var(--muted); font-weight:800; margin-bottom:8px;">ìµœê·¼ í™•ì¸ì¼</div>
          <div style="font-size:14px; font-weight:900;">${escapeHTML(stats.lastSignedAt)}</div>
        </div>
      </div>
    </div>
  </div>

    <div class="mi-card">
      <div style="font-weight:900; margin-bottom:10px;">ë‚´ ì •ë³´ ì„¤ì •</div>

      <div class="field">
        <div class="label">ì´ë¦„</div>
        <input id="miName" class="input" value="${escapeHTML(userName || '')}" placeholder="ì˜ˆ) ë°•íƒœìœ¨">
      </div>

      <div class="field">
        <div class="label">ë¶€ì„œ(ì„œëª…/ì œì•ˆ ìë™ ì…ë ¥)</div>
        <input id="miDept" class="input" value="${escapeHTML(userDept || '')}" placeholder="ì˜ˆ) ì œì¡°íŒ€">
      </div>

      <div class="cta" style="margin-top:10px;">
        <button class="btn ghost" id="miReset" type="button">ì´ˆê¸°í™”</button>
        <button class="btn primary" id="miSave" type="button">ì €ì¥</button>
      </div>
      <div style="font-size:11px; color:var(--muted); font-weight:700; margin-top:8px; line-height:1.4;">
        ì €ì¥í•˜ë©´ ì„œëª… ëª¨ë‹¬ì˜ â€œì´ë¦„/ë¶€ì„œâ€ê°€ ìë™ ì±„ì›Œì§‘ë‹ˆë‹¤.
      </div>
    </div>

    <div class="mi-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:900;">ë¯¸ì„œëª… ë¬¸ì„œ ì „ì²´</div>
        <div style="font-size:12px; color:var(--muted); font-weight:800;">${stats.pendingDocs.length}ê±´</div>
      </div>

      ${
        pendingTop.length === 0
          ? `<div class="mi-empty">í˜„ì¬ ë¯¸ì„œëª… ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`
        : `<div class="mi-list" style="max-height: 400px; overflow-y: auto;">
            ${pendingTop.map(d => `
              <div class="mi-item">
                <div style="min-width:0;">
                  <div class="mi-item-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${escapeHTML(d.title || 'ì œëª© ì—†ìŒ')}
                  </div>
                  <div class="mi-item-meta">
                    ë“±ë¡: ${d.createdAt ? formatTS(d.createdAt) : '-'}
                    ${isEducationDoc(d) ? ' Â· êµìœ¡' : ''}
                  </div>
                </div>
                <div class="mi-item-actions">
                  <button class="mi-smallbtn primary" type="button" data-open-doc="${escapeHTML(d.id)}">í™•ì¸</button>
                </div>
              </div>
            `).join('')}
          </div>`
      }
    </div>

    <div class="mi-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:900;">ìµœê·¼ í™•ì¸ ê¸°ë¡ (ìƒìœ„ 5)</div>
        <div style="font-size:12px; color:var(--muted); font-weight:800;">${stats.mySigs.length}ê±´</div>
      </div>

      ${
        recentSigned.length === 0
        ? `<div class="mi-empty">ì•„ì§ í™•ì¸(ì„œëª…) ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
        : `<div class="mi-list">
            ${recentSigned.map(s => {
              const doc = documents.find(d => d.id === s.documentId);
              return `
                <div class="mi-item">
                  <div style="min-width:0;">
                    <div class="mi-item-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      ${escapeHTML(doc?.title || '(ë¬¸ì„œëª… ì—†ìŒ)')}
                    </div>
                    <div class="mi-item-meta">
                      ${formatTS(s.signedAt)} Â· ${escapeHTML(s.signerDept || '')}
                    </div>
                  </div>
                  <div style="font-weight:900; color: var(--success);">âœ“</div>
                </div>
              `;
            }).join('')}
          </div>`
      }
    </div>

    <div class="mi-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:900;">ì°¨ëŸ‰ ì •ë¹„ ì•Œë¦¼ (ì„ë°•/ì§€ì—°)</div>
        <div style="font-size:12px; color:var(--muted); font-weight:800;">${vehicleTop.length}ê±´</div>
      </div>

      ${
        vehicleTop.length === 0
        ? `<div class="mi-empty">ì„ë°•/ì§€ì—° ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
        : `<div class="mi-list">
            ${vehicleTop.map(x => {
              const v = x.v;
              const st = x.st;
              const next = v.nextMaintenanceDate ? formatTS(v.nextMaintenanceDate) : '-';
              return `
                <div class="mi-item">
                  <div style="min-width:0;">
                    <div class="mi-item-title">${escapeHTML(v.vehicleNumber || '')} Â· ${escapeHTML(v.vehicleName || '')}</div>
                    <div class="mi-item-meta">ë‹¤ìŒ ì •ë¹„: ${escapeHTML(next)}</div>
                  </div>
                  <div class="status-chip ${st.class}" style="margin:0;">${st.text}</div>
                </div>
              `;
            }).join('')}
          </div>`
      }
    </div>
  `;
}

async function openMyInfoModalAndLoad(){
  const userName = localStorage.getItem('mslUserName');
  if(!userName){
    toast('âš ï¸ ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    showNameInputModal();
    return;
  }

  openMyInfoModal();
  if(miBody){
    miBody.innerHTML = `<div class="loading" style="padding:24px 10px;">ë‚´ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
  }

  // ìµœì‹  ë°ì´í„° ë°˜ì˜
  try{
    await loadDocumentsFromFirebase();
    await loadSignaturesFromFirebase();
    await loadVehiclesFromFirebase();
  }catch(e){}

  const userDept = localStorage.getItem('mslUserDept') || '';

  if(miBody){
    miBody.innerHTML = await renderMyInfoHTML(userName, userDept);

    // âœ… ë‚´ì •ë³´ ë‚´ "í™•ì¸" ë²„íŠ¼ë“¤: ì´ë²¤íŠ¸ ìœ„ì„
    miBody.addEventListener('click', (e) => {
      const openBtn = e.target.closest('[data-open-doc]');
      if(openBtn){
        const docId = openBtn.getAttribute('data-open-doc');
        closeMyInfoModal();
        openSignatureModal(docId);
        return;
      }
    }, { once: true });

    // ì €ì¥/ì´ˆê¸°í™” ë²„íŠ¼
    const saveBtn = document.getElementById('miSave');
    const resetBtn= document.getElementById('miReset');

    if(saveBtn){
      saveBtn.addEventListener('click', () => {
        const n = document.getElementById('miName')?.value.trim() || '';
        const d = document.getElementById('miDept')?.value.trim() || '';

        if(!n){
          toast('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        localStorage.setItem('mslUserName', n);
        localStorage.setItem('mslUserDept', d);

        toast('âœ… ë‚´ì •ë³´ ì €ì¥ ì™„ë£Œ');

        // ì œì•ˆí•˜ê¸° ë¶€ì„œ ìë™ ë°˜ì˜(ìˆìœ¼ë©´)
        const sDept = document.getElementById('sDept');
        if(d && sDept){
          const has = Array.from(sDept.options).some(o => o.value === d);
          if(has) sDept.value = d;
        }

        // ë°°ì§€ ê°±ì‹ 
        updateBadges();

        // í™”ë©´ ë‹¤ì‹œ ë Œë”
        miBody.innerHTML = renderMyInfoHTML(n, d);
      });
    }

    if(resetBtn){
      resetBtn.addEventListener('click', () => {
        if(confirm('ë‚´ì •ë³´(ì´ë¦„/ë¶€ì„œ)ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          localStorage.removeItem('mslUserName');
          localStorage.removeItem('mslUserDept');
          toast('ğŸ§¼ ì´ˆê¸°í™” ì™„ë£Œ');
          closeMyInfoModal();
          setTimeout(() => location.reload(), 200);
        }
      });
    }
  }
}


// =========================
// âœ… ì ‘ì†ì ì´ë¦„ í‘œì‹œ ë° ë³€ê²½
// =========================

// ì´ë¦„ pill ì—…ë°ì´íŠ¸
function updateUserNamePill() {
  const userName = localStorage.getItem('mslUserName');
  const userNameText = document.getElementById('userNameText');
  const userNamePill = document.getElementById('userNamePill');
  
  if (userName) {
    userNameText.textContent = `${userName}ë‹˜`;
    userNamePill.style.background = 'rgba(18,183,106,.20)';
    userNamePill.title = 'í´ë¦­í•˜ì—¬ ì´ë¦„ ë³€ê²½';
  } else {
    userNameText.textContent = 'ì´ë¦„ ì…ë ¥';
    userNamePill.style.background = 'rgba(255,59,92,.20)';
    userNamePill.title = 'í´ë¦­í•˜ì—¬ ì´ë¦„ ì…ë ¥';
  }
}

//ì´ë¦„ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
function openNameChangeModal() {
  const currentName = localStorage.getItem('mslUserName') || '';
  const currentDept = localStorage.getItem('mslUserDept') || '';
  
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.style.display = 'flex';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>ğŸ‘¤ ë‚´ ì •ë³´ ë³€ê²½</h3>
        <button class="icon-btn" onclick="this.closest('.modal').remove()" style="box-shadow:none; width:36px; height:36px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <div style="padding: 14px; border-radius: 12px; background: linear-gradient(135deg, rgba(43,107,255,.08), rgba(78,208,255,.06)); margin-bottom: 16px;">
          <div style="font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 4px;">ğŸ’¡ ì•ˆë‚´</div>
          <div style="font-size: 12px; color: var(--text); line-height: 1.5; font-weight: 600;">
            ë“±ë¡ëœ ì§ì›ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            <!--${employees.length}ëª…) -->
          </div>
        </div>
        
        <div class="field">
          <div class="label">ì´ë¦„</div>
          <input type="text" id="changeUserName" class="input" value="${escapeHTML(currentName)}" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autofocus>
          <div style="font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 600;">
            
          </div>
        </div>
        
        <div class="field">
          <div class="label">ë¶€ì„œ (ì„ íƒ)</div>
          <input type="text" id="changeUserDept" class="input" value="${escapeHTML(currentDept)}" placeholder="ì˜ˆ) ì œì¡°íŒ€, ê´€ë¦¬íŒ€ ë“±">
        </div>
        
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 12px; font-weight: 600; padding: 10px; border-radius: 10px; background: rgba(255,184,0,.08);">
          âš ï¸ ì´ë¦„ì„ ë³€ê²½í•˜ë©´ ì´ì „ ì„œëª… ê¸°ë¡ê³¼ ìƒˆ ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          <br>
          ğŸ”’ ë³´ì•ˆì„ ìœ„í•´ ë“±ë¡ëœ ì§ì›ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
        
        <div class="cta">
          <button class="btn ghost" onclick="this.closest('.modal').remove()">ì·¨ì†Œ</button>
          <button class="btn primary" onclick="saveNameChange(this)">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// ì´ë¦„ ë³€ê²½ ì €ì¥
function saveNameChange(btn) {
  const newName = document.getElementById('changeUserName').value.trim();
  const newDept = document.getElementById('changeUserDept').value.trim();
  
  // âœ… 1ì°¨ ê²€ì‚¬: ì´ë¦„ ì…ë ¥ í™•ì¸
  if (!newName) {
    toast('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  // âœ… 2ì°¨ ê²€ì‚¬: ë“±ë¡ëœ ì§ì›ì¸ì§€ í™•ì¸
  if (!employees.includes(newName)) {
    toast(`âŒ "${newName}"ì€(ëŠ”) ë“±ë¡ë˜ì§€ ì•Šì€ ì§ì›ì…ë‹ˆë‹¤`);
    
    // ìœ ì‚¬í•œ ì´ë¦„ ì¶”ì²œ
    const similar = employees.filter(emp => 
      emp.includes(newName.charAt(0)) || newName.includes(emp.charAt(0))
    );
    
    if (similar.length > 0) {
      setTimeout(() => {
        toast(`ğŸ’¡ í˜¹ì‹œ ì´ ë¶„ì„ ì°¾ìœ¼ì‹œë‚˜ìš”? ${similar.slice(0, 3).join(', ')}`);
      }, 1000);
    }
    
    return;
  }
  
  const originalText = btn.textContent;
  btn.textContent = 'ì €ì¥ ì¤‘...';
  btn.disabled = true;
  
  try {
    localStorage.setItem('mslUserName', newName);
    localStorage.setItem('mslUserDept', newDept);
    
    // UI ì—…ë°ì´íŠ¸
    updateUserNamePill();
    updateBadges();
    
    // í˜„ì¬ íƒ­ì— ë”°ë¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    const currentTab = document.querySelector('.tab.active')?.dataset.tab;
    if (currentTab === 'sign') {
      loadPendingDocuments();
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    btn.closest('.modal').remove();
    
    confetti({
      particleCount: 80,
      spread: 60,
      origin: { y: 0.6 },
      colors: ['#2B6BFF', '#4ED0FF', '#12B76A']
    });
    
    toast(`âœ… ${newName}ë‹˜ìœ¼ë¡œ ë³€ê²½ ì™„ë£Œ!`);
    
  } catch (error) {
    console.error('ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜:', error);
    toast('âŒ ë³€ê²½ ì‹¤íŒ¨');
    btn.textContent = originalText;
    btn.disabled = false;
  }
}



  </script>

<!-- âœ… ë‚´ì •ë³´ ëª¨ë‹¬: ë‹¨ì¼ ë²„ì „(ì¤‘ë³µ id ì—†ìŒ) -->
<div id="myInfoModal" class="mi-overlay" aria-hidden="true">
  <div class="mi-modal" role="dialog" aria-modal="true" aria-labelledby="miTitle">
    <div class="mi-head">
      <div class="mi-head-left">
        <div class="mi-title" id="miTitle">ë‚´ì •ë³´</div>
        <div class="mi-sub" id="miSub">ë‚´ ì´ìˆ˜í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <button type="button" class="mi-x" id="myInfoCloseBtn" aria-label="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="mi-body" id="myInfoBody">
      <!-- JSê°€ ë Œë”ë§ -->
    </div>

    <div class="mi-foot">
      <button type="button" class="mi-btn mi-btn-ghost" id="myInfoRefreshBtn">ìƒˆë¡œê³ ì¹¨</button>
      <button type="button" class="mi-btn mi-btn-primary" id="myInfoCloseBtn2">ë‹«ê¸°</button>
    </div>
  </div>
</div>


</body>
</html>
